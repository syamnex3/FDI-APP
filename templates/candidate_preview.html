<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Candidate Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #f3f4f6;
      font-family: 'Inter', sans-serif;
    }
    .question-panel {
  position: relative;
  background: #fff;
  border-radius: 0.5rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  padding: 1rem;
  margin-bottom: 1.5rem;
  transition: background 0.3s;
  overflow: hidden;
}

.question-panel::before {
  content: "Face D Interview";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) rotate(-20deg);
  font-size: 2.5rem;
  color: rgba(0, 0, 0, 0.08);
  font-weight: 1500px;
  white-space: nowrap;
  pointer-events: none;
  z-index: 0;
}

    .sidebar-btn {
      width: 2.2rem;
      height: 2.2rem;
      border-radius: 0.5rem;
      background: #e0e7ff;
      color: #1d2686;
      font-weight: bold;
      border: none;
      cursor: pointer;
      margin-bottom: 0.5rem;
    }
    .sidebar-btn.active,
    .sidebar-btn.answered {
      background: #1d2686 !important;
      color: #fff !important;
    }
    .question-panel.bg-green-100 { background: #d1fae5 !important; }
    .question-panel.bg-red-100 { background: #fee2e2 !important; }
   /* .correct-answer {
  border: 2px solid #10b981;
  border-radius: 6px;
  padding: 4px 8px;
}
.wrong-answer {
  border: 2px solid #ef4444;
  border-radius: 6px;
  padding: 4px 8px;
} */

  </style>
</head>
<body>
<div class="text-white text-center bg-green-600 py-2 font-semibold text-lg">
  ⏱ Time Left: <span id="timer">--:--</span>
</div>
<div id="timeoutAlert" class="hidden bg-yellow-100 text-yellow-800 text-center py-2 font-semibold text-sm">
  ⏱ Time’s up! Submitting your assessment...
</div>

<div class="flex max-w-6xl mx-auto mt-8 bg-white rounded-lg shadow">
  <div class="p-4 border-r min-w-[90px] bg-gray-50">
    <div class="mb-2 font-bold text-gray-700 text-center">Q Panel</div>
    <div class="grid grid-cols-5 gap-2">
      {% for q in questions %}
      <button type="button"
              data-index="{{ forloop.counter0 }}"
              class="sidebar-btn {% if forloop.first %}active{% endif %}">
        {{ forloop.counter|stringformat:"02d" }}
      </button>
      {% endfor %}
    </div>
  </div>

  <div class="flex-1 p-6">
    <form id="assessmentForm">
      {% for q in questions %}
      <div class="question-panel relative"
           data-question="{{ forloop.counter0 }}"
           data-qid="{{ q.question_id }}"
           {% if not forloop.first %}style="display:none"{% endif %}>
        <div class="mb-2 font-bold text-lg text-gray-900">Question {{ forloop.counter }}</div>
        <div class="mb-2 text-gray-800">{{ q.question_text_full|safe }}</div>
        {% if q.options %}
        <div class="mb-2 font-semibold text-gray-700">Options</div>
        <div class="options-list mb-2">
          {% for option in q.options %}
          <label class="block mb-1 flex items-center gap-2">
            <input type="radio"
                   name="question_{{ forloop.parentloop.counter0 }}"
                   value="{{ forloop.counter0 }}"
                   class="option-radio"
                   data-question="{{ forloop.parentloop.counter0 }}"
                   data-option="{{ forloop.counter0 }}">
            <span>{{ option }}</span>
          </label>
          {% endfor %}
        </div>
        <a href="#" class="text-blue-600 text-sm underline" onclick="clearResponse('{{ forloop.counter0 }}');return false;">Clear Response</a>
        {% endif %}
      </div>
      {% endfor %}
    </form>

    <div id="feedback" class="hidden p-2 rounded text-white text-center"></div>

    <div class="flex justify-between mt-8">
      <button id="prevBtn" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400" disabled>Previous</button>
      <button id="nextBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Next</button>
    </div>

    <div id="submitWrapper" class="hidden flex justify-center mt-8">
      <button id="submitBtn" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
        Submit
      </button>
    </div>
  </div>
</div>

<!-- Video Window at Bottom Right -->
<div id="video-window" style="
  position: fixed;
  bottom: 10px;
  right: 24px;
  width: 260px;
  height: 150px;
  background: #000;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.18);
  z-index: 9999;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
">
  <video id="webcam-video" width="100%" height="100%" autoplay muted playsinline style="object-fit: cover;"></video>
</div>
<script>
  // Start webcam stream in the video window
  window.addEventListener('DOMContentLoaded', function() {
    const video = document.getElementById('webcam-video');
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(function(stream) {
          video.srcObject = stream;
        })
        .catch(function(err) {
          video.parentElement.innerHTML = '<div style="color:white;text-align:center;width:100%;">Camera not available</div>';
        });
    } else {
      video.parentElement.innerHTML = '<div style="color:white;text-align:center;width:100%;">Camera not supported</div>';
    }
  });
</script>
<script>
  const questions = document.querySelectorAll('.question-panel');
  const sidebarBtns = document.querySelectorAll('.sidebar-btn');
  let current = 0;
  let answers = Array(questions.length).fill(null);
  const question_ids = Array.from(questions).map(q => q.getAttribute('data-qid'));
  let responseData = null;

  function saveCurrentAnswer() {
    const radios = questions[current].querySelectorAll('input[type="radio"]');
    radios.forEach(radio => {
      if (radio.checked) {
        answers[current] = radio.value;
        sidebarBtns[current].classList.add('answered');
      }
    });
  }

  function restoreAnswer(idx) {
    const radios = questions[idx].querySelectorAll('input[type="radio"]');
    radios.forEach(radio => {
      radio.checked = (answers[idx] === radio.value);
    });
  }

  function showFeedback(index) {
    const feedback = document.getElementById('feedback');
    if (!responseData) return feedback.classList.add("hidden");

    const isCorrect = responseData.results[index] === true;
    const correctAnswer = responseData.correct_answers[index];

    if (answers[index] === null || answers[index] === '') {
  feedback.textContent = "Option not selected. Correct answer: " + correctAnswer;
  feedback.className = "bg-yellow-500 p-2 rounded text-white text-center";
} else if (isCorrect) {
  feedback.textContent = "Correct!";
  feedback.className = "bg-green-500 p-2 rounded text-white text-center";
} else {
  feedback.textContent = "Incorrect. Correct answer: " + correctAnswer;
  feedback.className = "bg-red-500 p-2 rounded text-white text-center";
}


    feedback.className = (isCorrect ? "bg-green-500" : "bg-red-500") + " p-2 rounded text-white text-center";
    feedback.classList.remove("hidden");
  }

  function showQuestion(index) {
    questions[current].style.display = 'none';
    sidebarBtns[current].classList.remove('active');
    saveCurrentAnswer();
    current = index;
    questions[current].style.display = '';
    sidebarBtns[current].classList.add('active');

    document.getElementById('prevBtn').disabled = current === 0;
    document.getElementById('nextBtn').disabled = current === questions.length - 1;

    restoreAnswer(current);

    const submitWrapper = document.getElementById('submitWrapper');
    submitWrapper.classList.toggle('hidden', questions.length === 0 || current !== questions.length - 1);

    showFeedback(current);
  }

  sidebarBtns.forEach((btn, idx) => {
    btn.addEventListener('click', () => showQuestion(idx));
  });

  document.getElementById('prevBtn').addEventListener('click', e => {
    e.preventDefault();
    if (current > 0) showQuestion(current - 1);
  });

  document.getElementById('nextBtn').addEventListener('click', e => {
    e.preventDefault();
    if (current < questions.length - 1) showQuestion(current + 1);
  });

  function clearResponse(idx) {
    const radios = questions[idx].querySelectorAll('input[type="radio"]');
    radios.forEach(r => r.checked = false);
    answers[idx] = null;
    sidebarBtns[idx].classList.remove('answered');
  }

  let totalSeconds = Number("{{ total_seconds|default:0 }}");

  function updateTimer() {
    const min = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
    const sec = String(totalSeconds % 60).padStart(2, '0');
    document.getElementById('timer').textContent = `${min}:${sec}`;

    if (totalSeconds > 0) {
      totalSeconds--;
    } else {
      clearInterval(timerInterval);
      document.getElementById('timeoutAlert').classList.remove("hidden");
      setTimeout(() => document.getElementById('submitBtn').click(), 1000);
    }
  }

  let timerInterval = setInterval(updateTimer, 1000);
  updateTimer();

  document.getElementById('submitBtn').addEventListener('click', function (e) {
    e.preventDefault();
    clearInterval(timerInterval);
    this.disabled = true;

    answers = Array.from(questions).map((qPanel) => {
      const selected = qPanel.querySelector('input[type="radio"]:checked');
      return selected ? selected.value : null;
    });

    fetch("{% url 'check_answers' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
      },
      body: JSON.stringify({ answers: answers, question_ids: question_ids })
    })
    .then(res => res.json())
    .then(data => {
      responseData = data;

      questions.forEach((panel, idx) => {
        panel.classList.remove('bg-green-100', 'bg-red-100');
        if (data.results[idx] === true) {
          panel.classList.add('bg-green-100');
        } else {
          panel.classList.add('bg-red-100');
        }

        const correctIndexes = data.correct_answers[idx]
          .split(',')
          .map(x => parseInt(x.trim()))
          .filter(x => !isNaN(x));
        const selectedVal = answers[idx] !== null ? parseInt(answers[idx]) : null;

        const radios = panel.querySelectorAll('input[type="radio"]');
        radios.forEach(radio => {
          const optIndex = parseInt(radio.value);
          const labelSpan = radio.nextElementSibling;

          // Remove previous styles
          labelSpan.classList.remove('correct-answer', 'wrong-answer');

          // ✅ Green border for correct options
          if (correctIndexes.includes(optIndex)) {
            labelSpan.classList.add('correct-answer');
          }

          // ❌ Red border only on selected wrong option
          if (
            selectedVal !== null &&
            selectedVal === optIndex &&
            !correctIndexes.includes(optIndex)
          ) {
            labelSpan.classList.add('wrong-answer');
          }
        });
      });

      showFeedback(current);
      disableAllButtons(); // <-- Add this here
    });
  });

  function disableAllButtons() {
  // Disable navigation buttons
//   document.getElementById('prevBtn').disabled = true;
//   document.getElementById('nextBtn').disabled = true;
  document.getElementById('submitBtn').disabled = true;

  // Disable all Clear Response links
  document.querySelectorAll('a[onclick^="clearResponse"]').forEach(link => {
    link.classList.add('pointer-events-none', 'opacity-50');
    link.onclick = function(e) { e.preventDefault(); return false; };
    link.tabIndex = -1;
  });

  // Disable all radio buttons
  document.querySelectorAll('input[type="radio"]').forEach(radio => {
    radio.disabled = true;
  });
}

  // ✅ Initialize the first question on page load
  document.addEventListener('DOMContentLoaded', () => {
    if (questions.length > 0) {
      showQuestion(0);
    }
  });
  document.addEventListener('DOMContentLoaded', () => {
  if (localStorage.getItem('assessmentSubmitted') === 'true') {
    disableAllFunctionality();
    document.getElementById('submitWrapper').classList.add('hidden');
    document.getElementById('feedback').textContent = '✅ Assessment already submitted. Thank you.';
    document.getElementById('feedback').className = 'bg-blue-500 p-2 rounded text-white text-center';
    document.getElementById('feedback').classList.remove('hidden');
  } else {
    if (questions.length > 0) showQuestion(0);
  }
});
</script>


</body>
</html>
