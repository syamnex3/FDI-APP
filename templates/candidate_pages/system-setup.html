<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Interview Setup - Real-time with Snapshot</title>
    <style>
        /* Reset default browser styles for consistent rendering */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%; /* Ensure html and body take full height of the viewport */
            overflow: hidden; /* Prevent scrollbars on html/body if content fits */
        }

        /* Apply box-sizing globally for easier layout management */
        /* This ensures padding and borders are included in the element's total width/height */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column; /* Stack content vertically for header */
            justify-content: flex-start; /* Align to top to make space for header */
            align-items: center;
            min-height: 100vh; /* Ensure body takes at least full viewport height */
            color: #333;
        }

        /* Header Styles */
        .top-header {
            position: fixed;
            width: 100%;
            z-index: 100; /* Ensure it's above other content */
            background-color: #1d2686; /* Dark blue background for the whole bar */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            top: 0; /* Pin to the top */
            left: 0;
            display: flex;
            justify-content: flex-start; /* Align FDI to the left */
            align-items: center;
            padding: 12px 24px; /* Padding for the entire bar */
            height: 50px; /* Fixed height for consistency */
            box-sizing: border-box; /* Include padding in height */
        }
 
        .brand-title {
            color: #fff;
            font-size: 24px;
            font-weight: bold;
        }
 
        /* Main content wrapper to accommodate fixed header */
        .main-content-wrapper {
            width: 100%;
            height: calc(115vh - 90px); /* Adjust based on header height */
            display: flex;
            justify-content: center;
            align-items: center;
            padding-top: 40px; /* No extra padding here, height is calculated */
        }

        .interview-container {
            display: flex;
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100vh;
            background-color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background-color: #e8f0fe;
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-nav ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-nav li {
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            align-items: center;
        }
        .sidebar-nav li .step-number {
            background-color: #ccc;
            color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            font-size: 12px;
            flex-shrink: 0;
        }

        .sidebar-nav li.active {
            background-color: #0078d4;
            color: white;
        }
        .sidebar-nav li.active .step-number {
            background-color: #fff;
            color: #0078d4;
        }

        .sidebar-nav li:not(.active):hover {
            background-color: #d1e3fa;
        }

        /* New style for disabled sidebar items */
        .sidebar-nav li.disabled-nav-item {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }
        .sidebar-nav li.disabled-nav-item .step-number {
            background-color: #ccc;
            color: #fff;
        }

        .main-content {
            flex-grow: 1;
            padding: 25px 30px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .main-header {
            font-size: 24px;
            font-weight: 600;
            color: #005a9e;
            margin-bottom: 20px;
            text-align: center;
        }

        /* New style for the Previous Step navigation */
        #previous-step-nav {
            margin-bottom: 15px;
            text-align: left;
        }

        .btn-back-step {
            padding: 8px 15px;
            font-size: 13px;
            background-color: #607d8b; /* A darker grey for back button */
            color: white;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-back-step:hover {
            background-color: #455a64;
        }


        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 25px;
            flex-shrink: 0;
        }

        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #f0f2f5;
            border: none;
            border-bottom: 3px solid transparent;
            margin-right: 5px;
            font-size: 14px;
            color: #555;
            border-radius: 5px 5px 0 0;
            white-space: nowrap;
        }
        .tab-button .tab-number {
            display: inline-block;
            background-color: #ccc;
            color: #fff;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            text-align: center;
            line-height: 18px;
            margin-right: 6px;
            font-size: 11px;
        }

        .tab-button.active {
            background-color: #ffffff;
            border-bottom: 3px solid #0078d4;
            color: #0078d4;
            font-weight: 600;
        }
        .tab-button.active .tab-number {
            background-color: #0078d4;
            color: #fff;
        }

        .tab-content {
            display: none;
            flex-grow: 1;
        }

        .tab-content.active {
            display: block;
        }

        .video-check-area, .audio-check-area {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .camera-status, .mic-status {
            font-size: 13px;
            margin-bottom: 5px;
        }
        .camera-status .label, .mic-status .label {
            color: #777;
        }
        .status-text {
            font-weight: 600;
        }
        .status-text.connected { color: #28a745; }
        .status-text.error, .status-text.action-required { color: #dc3545; }
        .status-text.pending { color: #0078d4; }

        .camera-selector, .mic-selector {
            margin-top: 15px;
            font-size: 14px;
            color: #555;
        }
        .camera-selector select, .mic-selector select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-left: 5px;
            min-width: 200px;
        }

        .video-preview-container {
            margin-top: 15px;
            width: 100%;
            max-width: 320px;
            aspect-ratio: 4 / 3;
            background-color: #333;
            border: 1px solid #ccc;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            overflow: hidden;
            position: relative;
        }
        .video-preview-container video,
        .video-preview-container canvas,
        .video-preview-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }
        .video-preview-container canvas,
        .video-preview-container img {
            display: none;
        }


        .confirmation-prompt {
            margin-top: 15px;
            font-size: 14px;
            color: #333;
        }

        .action-buttons {
            margin-top: auto;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 20px;
        }

        .action-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .btn-secondary {
            background-color: #068afd;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-primary {
            background-color: #0078d4;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08); /* Added shadow */
        }
        .btn-primary:hover {
            background-color: #005a9e;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1); /* Slightly larger shadow on hover */
        }
        /* Adjusted disabled button styles to make them more visibly buttons */
        .btn-primary:disabled, .btn-secondary:disabled, .btn-positive:disabled {
            background-color: #bfdaed; /* Lighter shade of primary blue */
            color: #005a9e; /* Darker blue text for contrast */
            cursor: not-allowed;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Lighter shadow for disabled */
            border: 1px solid #0078d4; /* Keep a border for definition */
            opacity: 1; /* Remove opacity to keep solid look */
        }

        .btn-positive {
            background-color: #28a745;
            color: white;
        }
        .btn-positive:hover {
            background-color: #218838;
        }

        .step-label {
            font-size: 12px;
            color: #333;
            font-weight: bold;
            margin-bottom: 2px;
        }
        .step-label.active-step {
            color: #005a9e;
            font-weight: bold;
            text-decoration: underline;
        }
        .step-blurred {
            opacity: 0.6;
        }

        /* Styles for the audio waveform canvas */
        #audio-waveform-canvas {
            width: 100%;
            height: 80px;
            background-color: #e0e0e0;
            border-radius: 44px;
            margin-top: 10px;
            border: 1px solid #ccc;
            display: block;
        }

        .message-box {
            padding: 10px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 13px;
        }
        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message-box.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Styles for Personal Details Section */
        .personal-details-area {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            flex-grow: 1;
            display: flex;
            flex-direction: column; /* Ensure content stacks vertically */
            gap: 20px;
        }

        .capture-section {
            width: 100%; /* Ensure full width */
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .capture-section:last-of-type { /* Use last-of-type to target the last .capture-section */
            border-bottom: none;
            flex-grow: 1;
        }

        .capture-section h3 {
            font-size: 18px;
            color: #005a9e;
            margin-bottom: 10px;
        }

        .id-proof-align-text {
            font-size: 13px;
            color: #777;
            margin-bottom: 10px;
        }

        .id-outline-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1.58 / 1;
            background-color: #ddd;
            border: 2px dashed #0078d4;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #555;
            font-size: 14px;
            text-align: center;
        }
        /* Important: Ensure video is always shown if camera is active in this container */
        .id-outline-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block; /* Always show video when active */
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1; /* Ensure video is above placeholder */
        }
        .id-outline-container canvas,
        .id-outline-container img {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 2; /* Ensure snapshot is above video and placeholder */
        }
        .id-outline-container #id-outline-placeholder {
            display: flex; /* Default to flex for centering text */
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: #ddd;
            color: #555;
            font-size: 14px;
            text-align: center;
            z-index: 0; /* Ensure placeholder is at the bottom */
        }

        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-group select,
        .form-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }
        .form-group input[type="text"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }

        .personal-details-message-box {
            padding: 10px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 13px;
        }
        .personal-details-message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .personal-details-message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .personal-details-message-box.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Specific style to move action buttons closer in capture sections */
        .capture-section .action-buttons {
            margin-top: 15px;
            justify-content: flex-end; /* Align to right */
            gap: 10px;
        }

        /* Style for disabled capture section */
        .capture-section-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            filter: grayscale(100%);
        }

        /* Styles for Upload Resume Section */
        .upload-resume-area {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            text-align: center;
        }

        .upload-resume-area h3 {
            font-size: 18px;
            color: #005a9e;
            margin-bottom: 20px;
        }

        .drop-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            width: 80%;
            max-width: 500px;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
        }

        .drop-area:hover {
            border-color: #0078d4;
        }

        .drop-area input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 48px;
            color: #0078d4;
            margin-bottom: 15px;
        }

        .drop-area p {
            margin: 0;
            font-size: 14px;
            color: #555;
        }

        .upload-resume-area .action-buttons {
            margin-top: auto;
            width: 100%;
            justify-content: flex-end;
            padding-top: 0;
        }

        /* Styles for the section-level 'Next' button in Personal Details (now consistent with System Setup) */
        #personal-details-section-actions {
            margin-top: auto; /* Push to the bottom */
            display: flex; /* Initially hidden, controlled by JS */
            gap: 10px;
            justify-content: flex-end; /* Align to right corner */
            padding-top: 20px;
            width: 100%;
        }

        /* Custom Modal Styling */
        .custom-modal-style {
            position: fixed;
            left: 50%;
            top: 20px;
            transform: translateX(-50%);
            padding: 15px 25px;
            background-color: rgba(0,0,0,0.75);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10001;
            font-size: 14px;
            text-align: center;
            opacity: 1;
            transition: opacity 0.5s ease-out, top 0.5s ease-out;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-content-wrapper {
                height: calc(100vh - 80px);
            }
            .top-header {
                position: relative;
                box-shadow: none;
                height: auto;
                flex-direction: column;
                align-items: flex-start;
                padding: 10px 15px;
                gap: 10px;
            }
            .brand-title {
                font-size: 20px;
            }
            .interview-container {
                flex-direction: column;
                border-radius: 0;
                max-height: unset;
            }
            .sidebar {
                width: 100%;
                padding: 15px;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #e0e0e0;
            }
            .sidebar-nav {
                display: none;
            }
            .main-content {
                padding: 15px;
            }
            .tabs {
                flex-wrap: wrap;
                margin-bottom: 15px;
            }
            .tab-button {
                flex-grow: 1;
                margin-right: 0;
                border-radius: 5px;
                margin-bottom: 5px;
            }
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            .action-buttons button {
                width: 100%;
            }
            .video-preview-container, .id-outline-container {
                max-width: 100%;
            }
            .personal-details-area {
                flex-direction: column;
            }
            #personal-details-section-actions {
                position: static;
                margin-top: 20px;
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="top-header">
        <div class="brand-title">FDI</div>
    </div>

    <div class="main-content-wrapper">
        <div class="interview-container">
            <aside class="sidebar">
                <div class="sidebar-title"><strong>Live Interview</strong></div>
                <nav class="sidebar-nav">
                    <ul>
                        <li id="nav-system-setup" class="active" onclick="navigateTo('system-setup')">
                            <span class="step-number">1</span> System Setup
                        </li>
                        <li id="nav-personal-details" class="disabled-nav-item" onclick="navigateTo('personal-details')">
                            <span class="step-number">2</span> Personal Details
                        </li>
                        <li id="nav-upload-resume" class="disabled-nav-item" onclick="navigateTo('upload-resume')">
                            <span class="step-number">3</span> Upload Resume
                        </li>
                    </ul>
                </nav>
            </aside>

            <main class="main-content">
                <header class="main-header">System Setup</header>

                <div id="previous-step-nav" style="display: none; margin-bottom: 15px; text-align: left;">
                    <button class="btn-back-step" onclick="">&larr; Previous Step</button>
                </div>

                <div id="system-setup-content" class="tab-content active">
                    <div class="tabs">
                        <button id="video-check-tab" class="tab-button active" onclick="openTab('video-check')">
                            <span class="tab-number">1</span> STEP 1: Video Check
                        </button>
                        <button id="audio-check-tab" class="tab-button" onclick="openTab('audio-check')">
                            <span class="tab-number">2</span> STEP 2: Audio Check
                        </button>
                    </div>

                    <div id="video-check-content" class="tab-content active">
                        <div class="video-check-area">
                            <div class="camera-status">
                                <div class="step-label">STEP 1: CONNECT CAMERA</div>
                                <span class="label">Status: </span>
                                <span id="camera-connection-status" class="status-text pending">Requesting access...</span>
                            </div>
                            <div class="camera-status step-blurred" style="margin-top: 10px;">
                                <div class="step-label">STEP 2: VERIFY CAMERA</div>
                                <span class="label">Check: </span>
                                <span id="camera-verification-status" class="status-text action-required">Pending User Confirmation</span>
                            </div>

                            <div class="camera-selector">
                                Camera:
                                <select id="camera-dropdown" onchange="startSystemSetupCamera(this.value)">
                                    </select>
                            </div>

                            <div class="video-preview-container">
                                <video id="video-feed" autoplay playsinline muted></video>
                                <canvas id="snapshot-canvas"></canvas> <img id="snapshot-image" alt="Camera Snapshot"> </div>
                            <div id="video-error-message" class="message-box error" style="display: none;"></div>


                            <div class="confirmation-prompt">Can you see yourself in the camera?</div>
                            <div class="action-buttons">
                                <button class="btn-secondary" onclick="handleVideoConfirmation(false)">I can't see myself</button>
                                <button id="confirm-looks-good-btn" class="btn-positive" onclick="handleVideoConfirmation(true)">Yes, I look good</button>
                                <button id="next-to-audio-btn" class="btn-primary" onclick="goToAudioCheck()" disabled>Next: Audio Check</button>
                            </div>
                        </div>
                    </div>

                    <div id="audio-check-content" class="tab-content">
                        <div class="audio-check-area">
                            <h2>Audio Check</h2>
                            <div class="mic-status">
                                <div class="step-label">STEP 1: CONNECT MICROPHONE</div>
                                <span class="label">Status: </span>
                                <span id="mic-connection-status" class="status-text pending">Not Connected</span>
                            </div>
                            <div class="mic-selector">
                                Microphone:
                                <select id="mic-dropdown" onchange="handleMicSelection(this.value)">
                                    </select>
                            </div>
                            <div id="audio-waveform-container" style="margin-top:15px;">
                                <p>Click "Start Recording" to activate microphone and test:</p>
                                <canvas id="audio-waveform-canvas"></canvas>
                                <audio id="audio-player" controls style="width: 100%; margin-top: 15px; display: none;"></audio>
                            </div>
                            <div id="audio-error-message" class="message-box error" style="display: none;"></div>
                            <div class="confirmation-prompt">Can you hear yourself or see the audio level moving?</div>
                            <div class="action-buttons">
                                <button id="start-recording-btn" class="btn-primary" onclick="startRecording()" disabled>Start Recording</button>
                                <button id="stop-play-recording-btn" class="btn-secondary" onclick="toggleRecordPlayback()" disabled>Stop Recording</button>
                                <button class="btn-secondary" onclick="handleAudioConfirmation(false)">My audio doesn't work</button>
                                <button id="confirm-audio-works-btn" class="btn-positive" onclick="handleAudioConfirmation(true)" disabled>Yes, my audio works</button>
                                <button id="next-to-details-btn" class="btn-primary" onclick="goToPersonalDetails()" disabled>Next</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="personal-details-content" class="tab-content">
                    <div class="personal-details-area">
                        <!-- Personal Picture Capture Section (Step 1) -->
                        <div id="picture-capture-step" class="capture-section">
                            <div class="step-label">STEP 1: PICTURE CAPTURE</div>
                            <h3>Capture Your Picture</h3>
                            <div class="video-preview-container">
                                <video id="video-feed-personal" autoplay playsinline muted></video>
                                <canvas id="snapshot-canvas-personal"></canvas>
                                <img id="snapshot-image-personal" alt="Personal Picture Snapshot">
                            </div>
                            <div id="personal-picture-message" class="personal-details-message-box" style="display: none;"></div>
                            <div class="action-buttons">
                                <button id="capture-personal-picture-btn" class="btn-primary" onclick="capturePersonalPicture()" disabled>Capture My Picture</button>
                                <button id="recapture-personal-picture-btn" class="btn-secondary" onclick="recapturePersonalPicture()" disabled>Recapture</button>
                                <button id="next-to-id-capture-btn" class="btn-primary" onclick="showPhotoIDCaptureStep()" disabled>Next: Photo ID Capture</button>
                            </div>
                        </div>

                        <!-- Photo ID Capture Section (Step 2) - Initially hidden -->
                        <div id="photo-id-capture-step" class="capture-section" style="display: none;">
                            <div class="step-label">STEP 2: PHOTO ID CAPTURE</div>
                            <h3>Capture Photo ID</h3>
                            <div class="id-proof-align-text">Please ensure your photo identity proof is aligned to the outline.</div>
                            <div class="id-outline-container">
                                <video id="video-feed-id" autoplay playsinline muted></video>
                                <canvas id="snapshot-canvas-id"></canvas>
                                <img id="snapshot-image-id" alt="Photo ID Snapshot">
                                <div id="id-outline-placeholder">Align ID here</div>
                            </div>
                            <div id="id-picture-message" class="personal-details-message-box" style="display: none;"></div>

                            <div class="form-group">
                                <label for="identification-type">Select Identification Type</label>
                                <select id="identification-type">
                                    <option value="">-- Select --</option>
                                    <option value="aadhaar">Aadhaar</option>
                                    <option value="passport">Passport</option>
                                    <option value="drivers-license">Driver's License</option>
                                    <option value="pan">PAN</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="identification-number">Identification Number</label>
                                <input type="text" id="identification-number" placeholder="Number will be auto-extracted" readonly>
                            </div>

                            <div class="action-buttons">
                                <button id="capture-id-proof-btn" class="btn-primary" onclick="captureIdProofImage()" disabled>Capture Identity Proof Image</button>
                                <button id="recapture-id-proof-btn" class="btn-secondary" onclick="recaptureIdProofImage()" disabled>Recapture</button>
                            </div>
                        </div>
                        
                        <!-- Next button for the entire Personal Details section (to Upload Resume) -->
                        <div id="personal-details-section-actions">
                            <button id="next-from-personal-details-btn" class="btn-primary" onclick="navigateTo('upload-resume')" disabled>Next</button>
                        </div>
                    </div>
                </div>
                <div id="upload-resume-content" class="tab-content">
                    <div class="upload-resume-area">
                        <h3>Upload your latest resume (optional)</h3>
                        <div class="drop-area" id="resume-drop-area">
                            <input type="file" id="resume-file-input" accept=".pdf,.doc,.docx" onchange="handleResumeFile(this.files)">
                            <span class="upload-icon">&#x2191;</span> <p>Drag & drop or browse resume file</p>
                            <p>(Max file upload size: 5MB)</p>
                        </div>
                        <div id="resume-upload-message" class="message-box" style="display: none;"></div>
                        <div class="action-buttons">
                            <!-- MODIFIED LINE HERE: Changed onclick to proceedToInterview() -->
                            <button class="btn-primary" onclick="proceedToInterview()">Next</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // DOM Elements for System Setup
        const videoFeed = document.getElementById('video-feed');
        const snapshotCanvas = document.getElementById('snapshot-canvas');
        const snapshotImage = document.getElementById('snapshot-image');
        const cameraConnectionStatusEl = document.getElementById('camera-connection-status');
        const cameraVerificationStatusEl = document.getElementById('camera-verification-status');
        const cameraDropdown = document.getElementById('camera-dropdown');
        const micDropdown = document.getElementById('mic-dropdown');
        const nextToAudioBtn = document.getElementById('next-to-audio-btn');
        const nextToDetailsBtn = document.getElementById('next-to-details-btn');
        const micConnectionStatusEl = document.getElementById('mic-connection-status');
        const audioWaveformCanvas = document.getElementById('audio-waveform-canvas');
        const audioCanvasCtx = audioWaveformCanvas.getContext('2d');
        const audioPlayer = document.getElementById('audio-player');
        const startRecordingBtn = document.getElementById('start-recording-btn');
        const stopPlayRecordingBtn = document.getElementById('stop-play-recording-btn');

        const videoErrorMessageEl = document.getElementById('video-error-message');
        const audioErrorMessageEl = document.getElementById('audio-error-message');
        const confirmLooksGoodBtn = document.getElementById('confirm-looks-good-btn');
        const confirmAudioWorksBtn = document.getElementById('confirm-audio-works-btn');

        // DOM Elements for Personal Details (now referred to as steps)
        const pictureCaptureStep = document.getElementById('picture-capture-step');
        const photoIdCaptureStep = document.getElementById('photo-id-capture-step');

        const videoFeedPersonal = document.getElementById('video-feed-personal');
        const snapshotCanvasPersonal = document.getElementById('snapshot-canvas-personal');
        const snapshotImagePersonal = document.getElementById('snapshot-image-personal');
        const capturePersonalPictureBtn = document.getElementById('capture-personal-picture-btn');
        const recapturePersonalPictureBtn = document.getElementById('recapture-personal-picture-btn');
        const personalPictureMessageEl = document.getElementById('personal-picture-message');
        const nextToIdCaptureBtn = document.getElementById('next-to-id-capture-btn'); 

        const videoFeedId = document.getElementById('video-feed-id');
        const snapshotCanvasId = document.getElementById('snapshot-canvas-id');
        const snapshotImageId = document.getElementById('snapshot-image-id');
        const captureIdProofBtn = document.getElementById('capture-id-proof-btn');
        const recaptureIdProofBtn = document.getElementById('recapture-id-proof-btn');
        const idPictureMessageEl = document.getElementById('id-picture-message');
        const idOutlinePlaceholder = document.getElementById('id-outline-placeholder');
        const identificationType = document.getElementById('identification-type');
        const identificationNumber = document.getElementById('identification-number');
        const nextFromPersonalDetailsBtn = document.getElementById('next-from-personal-details-btn');
        const personalDetailsSectionActions = document.getElementById('personal-details-section-actions');


        // DOM Elements for Upload Resume
        const resumeDropArea = document.getElementById('resume-drop-area');
        const resumeFileInput = document.getElementById('resume-file-input');
        const resumeUploadMessageEl = document.getElementById('resume-upload-message');

        // Sidebar navigation items
        const navPersonalDetails = document.getElementById('nav-personal-details');
        const navUploadResume = document.getElementById('nav-upload-resume');

        // New DOM element for previous step navigation
        const previousStepNav = document.getElementById('previous-step-nav');
        const btnBackStep = previousStepNav.querySelector('.btn-back-step');


        let currentVideoStream = null;
        let currentAudioStream = null;
        let audioContext = null;
        let analyser = null;
        let microphoneSource = null;
        let dataArray = null;
        let animationFrameId = null;

        let mediaRecorder = null;
        let audioChunks = [];
        let recordedAudioBlob = null;

        let snapshotTaken = false; // For System Setup
        let personalPictureCaptured = false; // For Personal Details Step 1
        let idProofCaptured = false; // For Personal Details Step 2

        let personalDetailsVideoStream = null; // Stream for Personal Details section

        let currentActiveSidebarSectionId = 'system-setup';
        let currentActiveContentId = 'video-check-content';


        // --- Device Enumeration and Selection ---
        async function getMediaDevices() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                console.error("enumerateDevices() not supported.");
                showMessage(videoErrorMessageEl, "Your browser doesn't support device enumeration. Please use a modern browser.", 'error');
                return;
            }
            try {
                // Request permissions early to get device labels
                await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            } catch (permErr) {
                 console.warn("Initial permission request failed or was denied:", permErr);
            }

            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoInputs = devices.filter(device => device.kind === 'videoinput');
                const audioInputs = devices.filter(device => device.kind === 'audioinput');

                populateDropdown(cameraDropdown, videoInputs);
                populateDropdown(micDropdown, audioInputs);

                if (videoInputs.length > 0) {
                    if (cameraDropdown.value) {
                        startSystemSetupCamera(cameraDropdown.value);
                    } else if (videoInputs[0] && videoInputs[0].deviceId) {
                         cameraDropdown.value = videoInputs[0].deviceId;
                         startSystemSetupCamera(videoInputs[0].deviceId);
                    } else {
                        showMessage(videoErrorMessageEl, 'No default camera selected. Please choose from the dropdown.', 'error');
                    }
                } else {
                     cameraConnectionStatusEl.textContent = 'No camera found';
                     cameraConnectionStatusEl.className = 'status-text error';
                     showMessage(videoErrorMessageEl, 'No camera devices were found on your system.', 'error');
                }
                if (audioInputs.length > 0) {
                    micConnectionStatusEl.textContent = 'Microphone ready for activation';
                    micConnectionStatusEl.className = 'status-text pending';
                    startRecordingBtn.disabled = false;
                } else {
                    micConnectionStatusEl.textContent = 'No microphone found';
                    micConnectionStatusEl.className = 'status-text error';
                    startRecordingBtn.disabled = true;
                }

            } catch (err) {
                console.error("Error enumerating devices:", err);
                showMessage(videoErrorMessageEl, `Error accessing media devices: ${err.message}. Please ensure you've granted permissions.`, 'error');
            }
        }

        function populateDropdown(dropdownElement, devices) {
            dropdownElement.innerHTML = '';
            if (devices.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.text = "No devices found";
                dropdownElement.add(option);
                dropdownElement.disabled = true;
                return;
            }
            dropdownElement.disabled = false;
            devices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `Device ${index + 1} (${device.kind.replace('input', '')})`;
                dropdownElement.add(option);
            });
        }

        // --- System Setup Camera Logic ---
        async function startSystemSetupCamera(deviceId) {
            if (snapshotTaken) return;

            showMessage(videoErrorMessageEl, '');
            if (currentVideoStream) {
                currentVideoStream.getTracks().forEach(track => track.stop());
            }
            cameraConnectionStatusEl.textContent = 'Connecting...';
            cameraConnectionStatusEl.className = 'status-text pending';
            nextToAudioBtn.disabled = true;
            videoFeed.style.display = 'block';
            snapshotImage.style.display = 'none';

            const constraints = {
                video: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            };

            try {
                currentVideoStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoFeed.srcObject = currentVideoStream;
                videoFeed.onloadedmetadata = () => {
                    videoFeed.play();
                    cameraConnectionStatusEl.textContent = 'Connected';
                    cameraConnectionStatusEl.className = 'status-text connected';
                    cameraVerificationStatusEl.textContent = 'Pending User Confirmation';
                    cameraVerificationStatusEl.className = 'status-text action-required';
                    confirmLooksGoodBtn.disabled = false;
                };
            } catch (err) {
                console.error("Error accessing camera for System Setup:", err);
                cameraConnectionStatusEl.textContent = 'Access Denied or Error';
                cameraConnectionStatusEl.className = 'status-text error';
                let userMessage = `Could not access the camera. Error: ${err.name}. `;
                if (err.name === "NotAllowedError") {
                    userMessage += "Please grant camera permission in your browser settings and refresh the page.";
                } else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") {
                    userMessage += "No camera was found. Ensure it's connected and not in use by another application.";
                } else if (err.name === "NotReadableError" || err.name === "TrackStartError") {
                    userMessage += "The camera might be in use by another application or there's a hardware issue.";
                } else {
                     userMessage += "Please check your camera connection and browser permissions.";
                }
                showMessage(videoErrorMessageEl, userMessage, 'error');
                videoFeed.srcObject = null;
                confirmLooksGoodBtn.disabled = true;
            }
        }

        function takeSystemSetupSnapshot() {
            if (!currentVideoStream || !videoFeed.srcObject || videoFeed.readyState < videoFeed.HAVE_METADATA) {
                showMessage(videoErrorMessageEl, "Camera not ready or stream not available to take a snapshot.", 'error');
                return false;
            }

            const context = snapshotCanvas.getContext('2d');
            snapshotCanvas.width = videoFeed.videoWidth;
            snapshotCanvas.height = videoFeed.videoHeight;
            context.drawImage(videoFeed, 0, 0, snapshotCanvas.width, snapshotCanvas.height);

            snapshotImage.src = snapshotCanvas.toDataURL('image/png');
            snapshotImage.style.display = 'block';
            videoFeed.style.display = 'none';

            if (currentVideoStream) {
                currentVideoStream.getTracks().forEach(track => track.stop());
                currentVideoStream = null;
            }
            cameraConnectionStatusEl.textContent = 'Snapshot Taken';
            cameraConnectionStatusEl.className = 'status-text connected';
            snapshotTaken = true;
            confirmLooksGoodBtn.disabled = true;
            cameraDropdown.disabled = true;
            return true;
        }


        function handleVideoConfirmation(canSee) {
            if (canSee) {
                if (takeSystemSetupSnapshot()) {
                    cameraVerificationStatusEl.textContent = 'User Confirmed & Snapshot Taken';
                    cameraVerificationStatusEl.className = 'status-text connected'; 
                    nextToAudioBtn.disabled = false;
                    showMessage(videoErrorMessageEl, 'Snapshot captured! Click "Next" to proceed.', 'success');
                } else {
                    nextToAudioBtn.disabled = true;
                }
            } else {
                cameraVerificationStatusEl.textContent = 'User Cannot See Video';
                cameraVerificationStatusEl.className = 'status-text error';
                nextToAudioBtn.disabled = true;
                showMessage(videoErrorMessageEl, "Please try selecting a different camera, check permissions, or ensure your camera is not covered. If the issue persists, your camera might not be working correctly.", 'error');
                cameraDropdown.disabled = false;
                snapshotTaken = false;
                confirmLooksGoodBtn.disabled = false;
                if (!currentVideoStream && cameraDropdown.value) {
                    startSystemSetupCamera(cameraDropdown.value);
                }
            }
        }

        function showMessage(element, message, type = '') {
            element.textContent = message;
            element.className = `message-box ${type}`;
            element.style.display = message ? 'block' : 'none';
        }


        // --- Audio Logic ---

        // Function to initialize and start audio stream (called by startRecording)
        async function initAndStartAudioStream(deviceId) {
            showMessage(audioErrorMessageEl, '');
            if (currentAudioStream) {
                currentAudioStream.getTracks().forEach(track => track.stop());
                if (analyser) analyser.disconnect();
                if (microphoneSource) microphoneSource.disconnect();
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
            }

            micConnectionStatusEl.textContent = 'Connecting...';
            micConnectionStatusEl.className = 'status-text pending';
            confirmAudioWorksBtn.disabled = true;
            stopPlayRecordingBtn.disabled = true;
            audioPlayer.style.display = 'none';
            audioPlayer.src = '';
            audioCanvasCtx.clearRect(0, 0, audioWaveformCanvas.width, audioWaveformCanvas.height);

            const constraints = {
                audio: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    echoCancellation: true
                }
            };

            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                currentAudioStream = await navigator.mediaDevices.getUserMedia(constraints);
                micConnectionStatusEl.textContent = 'Connected & Recording';
                micConnectionStatusEl.className = 'status-text connected';
                showMessage(audioErrorMessageEl, 'Microphone activated. Recording started. Speak to see the waveform.', 'success');

                audioWaveformCanvas.width = audioWaveformCanvas.offsetWidth;
                audioWaveformCanvas.height = audioWaveformCanvas.offsetHeight;

                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048; // Set FFT size for analysis
                analyser.smoothingTimeConstant = 0.8; // Apply smoothing for a gentler waveform
                dataArray = new Uint8Array(analyser.frequencyBinCount); // Use frequencyBinCount for frequency data

                microphoneSource = audioContext.createMediaStreamSource(currentAudioStream);
                microphoneSource.connect(analyser);

                mediaRecorder = new MediaRecorder(currentAudioStream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    recordedAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(recordedAudioBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.display = 'block';
                    stopPlayRecordingBtn.textContent = 'Play Recorded Audio';
                    stopPlayRecordingBtn.disabled = false;
                    startRecordingBtn.disabled = false;
                    confirmAudioWorksBtn.disabled = false;
                    showMessage(audioErrorMessageEl, 'Recording stopped. Click "Play Recorded Audio" to listen.', 'success');

                    if (currentAudioStream) {
                        currentAudioStream.getTracks().forEach(track => track.stop());
                        currentAudioStream = null;
                    }
                    if (analyser) analyser.disconnect();
                    if (microphoneSource) microphoneSource.disconnect();
                    analyser = null;
                    microphoneSource = null;

                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }

                    micConnectionStatusEl.textContent = 'Recording Stopped';
                    micConnectionStatusEl.className = 'status-text pending';
                    audioCanvasCtx.clearRect(0, 0, audioWaveformCanvas.width, audioWaveformCanvas.height);
                };

                mediaRecorder.onerror = event => {
                    console.error("MediaRecorder error:", event.error);
                    showMessage(audioErrorMessageEl, `Recording error: ${event.error.name}. Please try again.`, 'error');
                    startRecordingBtn.disabled = false;
                    stopPlayRecordingBtn.disabled = true;
                    stopPlayRecordingBtn.textContent = 'Stop Recording';
                    if (currentAudioStream) {
                        currentAudioStream.getTracks().forEach(track => track.stop());
                        currentAudioStream = null;
                    }
                    if (analyser) analyser.disconnect();
                    if (microphoneSource) microphoneSource.disconnect();
                    analyser = null;
                    microphoneSource = null;
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                    }
                    audioCanvasCtx.clearRect(0, 0, audioWaveformCanvas.width, audioWaveformCanvas.height);
                };

                visualizeAudio();

            } catch (err) {
                console.error("Error accessing microphone:", err);
                micConnectionStatusEl.textContent = 'Access Denied or Error';
                micConnectionStatusEl.className = 'status-text error';
                let userMessage = `Could not access the microphone. Error: ${err.name}. `;
                if (err.name === "NotAllowedError") {
                    userMessage += "Please grant microphone permission in your browser settings and try again.";
                } else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") {
                    userMessage += "No microphone was found. Ensure it's connected and not in use by another application.";
                } else {
                     userMessage += "Please check your microphone connection and browser permissions.";
                }
                showMessage(audioErrorMessageEl, userMessage, 'error');
                confirmAudioWorksBtn.disabled = true;
                startRecordingBtn.disabled = true;
                stopPlayRecordingBtn.disabled = true;
            }
        }

        function handleMicSelection(deviceId) {
            if (currentAudioStream) {
                currentAudioStream.getTracks().forEach(track => track.stop());
                currentAudioStream = null;
            }
            if (analyser) analyser.disconnect();
            if (microphoneSource) microphoneSource.disconnect();
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            audioPlayer.style.display = 'none';
            audioPlayer.src = '';
            audioCanvasCtx.clearRect(0, 0, audioWaveformCanvas.width, audioWaveformCanvas.height);

            micConnectionStatusEl.textContent = 'Microphone ready for activation';
            micConnectionStatusEl.className = 'status-text pending';
            startRecordingBtn.disabled = !micDropdown.value; // Disable if no mic selected
            stopPlayRecordingBtn.disabled = true;
            confirmAudioWorksBtn.disabled = true;
            showMessage(audioErrorMessageEl, 'Microphone selected. Click "Start Recording" to activate and begin recording.', 'success');
        }


        function visualizeAudio() {
            if (!analyser || !currentAudioStream || currentAudioStream.getTracks().length === 0 || !currentAudioStream.getTracks()[0].enabled) {
                audioCanvasCtx.clearRect(0, 0, audioWaveformCanvas.width, audioWaveformCanvas.height);
                animationFrameId = null;
                return;
            }

            animationFrameId = requestAnimationFrame(visualizeAudio);

            analyser.getByteFrequencyData(dataArray); // Get frequency data for bars

            audioCanvasCtx.fillStyle = 'rgb(224, 224, 224)'; // Canvas background
            audioCanvasCtx.fillRect(0, 0, audioWaveformCanvas.width, audioWaveformCanvas.height);

            const barWidth = 4; // Width of each bar
            const barSpacing = 1; // Space between bars
            let x = 0;

            const numBars = Math.floor(audioWaveformCanvas.width / (barWidth + barSpacing));
            const dataSliceSize = Math.floor(dataArray.length / numBars);

            for (let i = 0; i < numBars; i++) {
                // Calculate average intensity for a slice of data
                let sum = 0;
                for (let j = 0; j < dataSliceSize; j++) {
                    sum += dataArray[i * dataSliceSize + j];
                }
                const avgIntensity = sum / dataSliceSize;

                // Scale bar height from 0-255 to canvas height
                const barHeight = Math.max(2, avgIntensity / 255 * audioWaveformCanvas.height); // Minimum height to always be visible

                audioCanvasCtx.fillStyle = '#3b82f6'; // Blue color for bars
                // Draw rectangles from the bottom up
                audioCanvasCtx.fillRect(x, audioWaveformCanvas.height - barHeight, barWidth, barHeight);

                x += barWidth + barSpacing;
            }
        }

        async function startRecording() {
            if (!micDropdown.value) {
                showMessage(audioErrorMessageEl, 'Please select a microphone from the dropdown first.', 'error');
                return;
            }

            if (!currentAudioStream || !mediaRecorder || mediaRecorder.state === 'inactive') {
                await initAndStartAudioStream(micDropdown.value);
            }

            if (mediaRecorder && mediaRecorder.state === 'inactive') {
                audioChunks = [];
                recordedAudioBlob = null;
                audioPlayer.style.display = 'none';
                audioPlayer.src = '';
                mediaRecorder.start();
                startRecordingBtn.disabled = true;
                stopPlayRecordingBtn.disabled = false;
                stopPlayRecordingBtn.textContent = 'Stop Recording';
                confirmAudioWorksBtn.disabled = true;
                showMessage(audioErrorMessageEl, 'Recording started... speak into your microphone.', 'success');
            } else {
                showMessage(audioErrorMessageEl, 'Microphone not ready or already recording.', 'error');
            }
        }

        function toggleRecordPlayback() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            } else if (recordedAudioBlob) {
                playRecordedAudio();
            } else {
                showMessage(audioErrorMessageEl, 'No audio recorded yet. Click "Start Recording" first.', 'error');
            }
        }

        function playRecordedAudio() {
            if (audioPlayer.src) {
                audioPlayer.play();
                stopPlayRecordingBtn.disabled = true;
                stopPlayRecordingBtn.textContent = 'Playing...';
                audioPlayer.onended = () => {
                    stopPlayRecordingBtn.disabled = false;
                    stopPlayRecordingBtn.textContent = 'Play Recorded Audio';
                };
            } else {
                showMessage(audioErrorMessageEl, 'No recorded audio to play.', 'error');
            }
        }


        function handleAudioConfirmation(audioWorks) {
            if (audioWorks) {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                if (!audioPlayer.paused) {
                    audioPlayer.pause();
                }

                nextToDetailsBtn.disabled = false;
                confirmAudioWorksBtn.disabled = true;
                startRecordingBtn.disabled = true;
                stopPlayRecordingBtn.disabled = true;
                stopPlayRecordingBtn.textContent = 'Stop Recording';
                showMessage(audioErrorMessageEl, 'Audio confirmed! Click "Next" to proceed to Personal Details.', 'success');
            } else {
                nextToDetailsBtn.disabled = true;
                showMessage(audioErrorMessageEl, "Please try selecting a different microphone, check permissions, or ensure your microphone is not muted. If the issue persists, your microphone might not be working correctly.", 'error');
                confirmAudioWorksBtn.disabled = false;
                startRecordingBtn.disabled = false;
            }
            updateSidebarNavigationStates();
        }

        // --- Personal Details Specific Camera Logic ---
        async function startPersonalDetailsCamera(deviceId) {
            console.log("startPersonalDetailsCamera: Attempting to start camera with deviceId:", deviceId);
            if (personalDetailsVideoStream) {
                console.log("startPersonalDetailsCamera: Stopping existing stream.");
                personalDetailsVideoStream.getTracks().forEach(track => track.stop());
                personalDetailsVideoStream = null;
            }

            // Initially hide video and show placeholder/message
            videoFeedPersonal.style.display = 'none';
            snapshotImagePersonal.style.display = 'none';
            videoFeedId.style.display = 'none';
            snapshotImageId.style.display = 'none';
            idOutlinePlaceholder.style.display = 'flex';
            idOutlinePlaceholder.textContent = "Loading camera..."; // Initial loading state

            // Disable capture buttons until camera is confirmed
            capturePersonalPictureBtn.disabled = true;
            captureIdProofBtn.disabled = true;


            const constraints = {
                video: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                personalDetailsVideoStream = stream;
                console.log("startPersonalDetailsCamera: Camera stream obtained successfully.");

                videoFeedPersonal.srcObject = stream;
                videoFeedId.srcObject = stream;

                videoFeedPersonal.onloadedmetadata = () => {
                    videoFeedPersonal.play();
                    console.log("videoFeedPersonal: Metadata loaded, playing stream.");
                    videoFeedPersonal.style.display = 'block'; // Ensure video is visible
                    snapshotImagePersonal.style.display = 'none'; // Ensure snapshot is hidden
                    capturePersonalPictureBtn.disabled = false; // Enable capture button
                    showMessage(personalPictureMessageEl, 'Camera active. You can capture your picture now.', 'info');
                };
                videoFeedId.onloadedmetadata = () => {
                    videoFeedId.play();
                    console.log("videoFeedId: Metadata loaded, playing stream.");
                    idOutlinePlaceholder.style.display = 'none'; // Hide placeholder
                    videoFeedId.style.display = 'block'; // Ensure video is visible
                    snapshotImageId.style.display = 'none'; // Ensure snapshot is hidden
                    updateCaptureIdProofButtonState(); // Re-evaluate ID capture button state
                    showMessage(idPictureMessageEl, "Align your ID card within the frame and click 'Capture'.", 'info');
                };

                return stream;
            } catch (err) {
                console.error(`Error accessing camera for Personal Details section:`, err);
                personalDetailsVideoStream = null;
                let userMessage = `Could not access the camera for personal details. Error: ${err.name}. `;
                if (err.name === "NotAllowedError") {
                    userMessage += "Please grant camera permission in your browser settings and refresh the page.";
                } else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") {
                    userMessage += "No camera was found. Ensure it's connected and not in use by another application.";
                } else if (err.name === "NotReadableError" || err.name === "TrackStartError") {
                    userMessage += "The camera might be in use by another application or there's a hardware issue.";
                } else {
                     userMessage += "Please check your camera connection and browser permissions.";
                }
                showMessage(personalPictureMessageEl, userMessage, 'error');
                showMessage(idPictureMessageEl, userMessage, 'error');
                videoFeedPersonal.srcObject = null;
                videoFeedId.srcObject = null;
                
                // On error, ensure video is hidden and placeholder is visible
                videoFeedPersonal.style.display = 'none';
                snapshotImagePersonal.style.display = 'none';
                videoFeedId.style.display = 'none';
                snapshotImageId.style.display = 'none';
                idOutlinePlaceholder.style.display = 'flex';
                idOutlinePlaceholder.textContent = "Camera failed to start.";

                // Disable all related buttons on camera failure
                capturePersonalPictureBtn.disabled = true;
                nextToIdCaptureBtn.disabled = true;
                captureIdProofBtn.disabled = true;
                recapturePersonalPictureBtn.disabled = true;
                recaptureIdProofBtn.disabled = true;

                throw err;
            }
        }

        function takePersonalDetailsSnapshot(videoElementId, canvasElementId, imageElementId, messageElementId) {
            const videoEl = document.getElementById(videoElementId);
            const canvasEl = document.getElementById(canvasElementId);
            const imageEl = document.getElementById(imageElementId);
            const messageEl = document.getElementById(messageElementId);

            console.log(`takePersonalDetailsSnapshot called for ${videoElementId}.`);
            console.log("Video element srcObject:", videoEl.srcObject);
            console.log("Video element readyState:", videoEl.readyState);
            console.log("Personal details video stream:", personalDetailsVideoStream);


            if (!personalDetailsVideoStream || !videoEl.srcObject || videoEl.readyState < videoEl.HAVE_METADATA) {
                const errorMessage = "Camera not ready or stream not available to take a snapshot. Ensure camera is connected and permissions are granted.";
                showMessage(messageEl, errorMessage, 'error');
                console.error("Snapshot failed:", errorMessage);
                return false;
            }

            try {
                const context = canvasEl.getContext('2d');
                canvasEl.width = videoEl.videoWidth;
                canvasEl.height = videoEl.videoHeight;
                context.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);

                imageEl.src = canvasEl.toDataURL('image/png');
                imageEl.style.display = 'block';
                videoEl.style.display = 'none'; // Hide video, show snapshot

                if (videoElementId === 'video-feed-id') {
                    idOutlinePlaceholder.style.display = 'none'; // Hide placeholder after snapshot
                }

                showMessage(messageEl, 'Snapshot captured successfully!', 'success');
                console.log("Snapshot taken successfully for", videoElementId);
                return true;
            } catch (e) {
                const errorMessage = `Error taking snapshot: ${e.message}.`;
                showMessage(messageEl, errorMessage, 'error');
                console.error("Snapshot failed due to drawing error:", e);
                return false;
            }
        }


        function initPersonalDetailsCameras() {
            const selectedCameraId = cameraDropdown.value;

            // Clear previous messages and reset initial display states
            showMessage(personalPictureMessageEl, '', '');
            showMessage(idPictureMessageEl, '', '');
            previousStepNav.style.display = 'none';
            personalDetailsSectionActions.style.display = 'none'; // Hide the final 'Next' button initially

            // Initially disable all capture and navigation buttons until camera is confirmed active
            capturePersonalPictureBtn.disabled = true;
            recapturePersonalPictureBtn.disabled = true;
            nextToIdCaptureBtn.disabled = true;
            captureIdProofBtn.disabled = true;
            recaptureIdProofBtn.disabled = true;
            nextFromPersonalDetailsBtn.disabled = true;

            // Ensure video elements are ready to display stream
            videoFeedPersonal.style.display = 'block'; // Will show video if successful
            snapshotImagePersonal.style.display = 'none';
            videoFeedId.style.display = 'block'; // Will show video if successful
            snapshotImageId.style.display = 'none';
            idOutlinePlaceholder.style.display = 'none'; // Video should cover this if successful

            if (!selectedCameraId) {
                const noCameraMessage = 'No camera selected in System Setup. Please go back to System Setup to select and confirm your camera.';
                showMessage(personalPictureMessageEl, noCameraMessage, 'error');
                showMessage(idPictureMessageEl, noCameraMessage, 'error');
                idOutlinePlaceholder.style.display = 'flex'; // Show placeholder if no camera
                idOutlinePlaceholder.textContent = "No camera available. Check System Setup.";
                videoFeedPersonal.style.display = 'none';
                videoFeedId.style.display = 'none';
                return; // Exit early if no camera ID
            }

            console.log("initPersonalDetailsCameras: Attempting to start camera for Personal Details.");
            startPersonalDetailsCamera(selectedCameraId)
                .then(stream => {
                    if (stream && stream.active && stream.getTracks().length > 0 && stream.getTracks()[0].enabled) {
                        console.log("initPersonalDetailsCameras: Camera started successfully for Personal Details.");
                        // Enable capture button for personal picture, as stream is active
                        capturePersonalPictureBtn.disabled = false;
                        showMessage(personalPictureMessageEl, 'Camera active. You can capture your picture now.', 'info');
                    } else {
                        const failedStreamMessage = 'Failed to activate camera for Personal Details. Please ensure camera is connected and permissions are granted, then try System Setup again.';
                        showMessage(personalPictureMessageEl, failedStreamMessage, 'error');
                        showMessage(idPictureMessageEl, failedStreamMessage, 'error');
                        idOutlinePlaceholder.style.display = 'flex';
                        idOutlinePlaceholder.textContent = "Camera failed to start.";
                        videoFeedPersonal.style.display = 'none';
                        videoFeedId.style.display = 'none';
                    }
                })
                .catch(err => {
                    // Error message already handled by startPersonalDetailsCamera's catch block
                    console.error("initPersonalDetailsCameras: Catching error from startPersonalDetailsCamera:", err);
                });

            personalPictureCaptured = false;
            idProofCaptured = false;

            // Ensure only the first step is visible initially
            pictureCaptureStep.style.display = 'flex'; // Ensure flex to maintain column layout
            photoIdCaptureStep.style.display = 'none';
        }

        function updatePersonalDetailsOverallNextButtonState() {
            // This button moves from Personal Details to Upload Resume
            if (personalPictureCaptured && idProofCaptured) {
                nextFromPersonalDetailsBtn.disabled = false;
                navUploadResume.classList.remove('disabled-nav-item');
            } else {
                nextFromPersonalDetailsBtn.disabled = true;
                navUploadResume.classList.add('disabled-nav-item');
            }
        }

        function capturePersonalPicture() {
            console.log("capturePersonalPicture called.");
            if (takePersonalDetailsSnapshot('video-feed-personal', 'snapshot-canvas-personal', 'snapshot-image-personal', 'personal-picture-message')) {
                personalPictureCaptured = true;
                capturePersonalPictureBtn.disabled = true;
                recapturePersonalPictureBtn.disabled = false;
                nextToIdCaptureBtn.disabled = false; // Enable next button for step 1
                showMessage(personalPictureMessageEl, 'Personal picture captured! Click "Next" to proceed to Photo ID Capture.', 'success');
                updatePersonalDetailsOverallNextButtonState();
            }
        }

        function recapturePersonalPicture() {
            personalPictureCaptured = false;
            capturePersonalPictureBtn.disabled = false;
            recapturePersonalPictureBtn.disabled = true;
            nextToIdCaptureBtn.disabled = true; // Disable next button for step 1
            snapshotImagePersonal.style.display = 'none';
            videoFeedPersonal.style.display = 'block'; // Show live video feed again
            showMessage(personalPictureMessageEl, 'Ready to recapture your picture.', 'info');

            // Reset ID capture section as well
            idProofCaptured = false;
            captureIdProofBtn.disabled = true;
            recaptureIdProofBtn.disabled = true;
            identificationType.value = ""; // Clear selected type
            identificationNumber.value = ""; // Clear extracted number
            snapshotImageId.style.display = 'none';
            // Show live video feed in ID frame as well if camera is active
            if (personalDetailsVideoStream && personalDetailsVideoStream.active) {
                videoFeedId.style.display = 'block';
                idOutlinePlaceholder.style.display = 'none';
            } else {
                videoFeedId.style.display = 'none';
                idOutlinePlaceholder.style.display = 'flex';
                idOutlinePlaceholder.textContent = "Camera not active. Check System Setup.";
            }
            showMessage(idPictureMessageEl, '', '');
            
            // Ensure first step is visible again
            pictureCaptureStep.style.display = 'flex';
            photoIdCaptureStep.style.display = 'none';
            
            // Hide previous step button when back to first step of Personal Details
            previousStepNav.style.display = 'none';
            // Hide the final 'Next' button
            personalDetailsSectionActions.style.display = 'none';


            updatePersonalDetailsOverallNextButtonState();
        }

        // Function to show the Photo ID Capture step
        function showPhotoIDCaptureStep() {
            pictureCaptureStep.style.display = 'none';
            photoIdCaptureStep.style.display = 'flex'; // Use flex to maintain column layout
            
            // Ensure video feed is active in ID capture frame
            if (personalDetailsVideoStream && personalDetailsVideoStream.active) {
                videoFeedId.style.display = 'block';
                snapshotImageId.style.display = 'none'; // Hide any previous snapshot
                idOutlinePlaceholder.style.display = 'none'; // Hide placeholder
            } else {
                videoFeedId.style.display = 'none';
                snapshotImageId.style.display = 'none';
                idOutlinePlaceholder.style.display = 'flex';
                idOutlinePlaceholder.textContent = "Camera not active. Check System Setup.";
                showMessage(idPictureMessageEl, "Camera not active for ID capture. Please ensure camera is working and try System Setup again.", 'error');
            }

            // Re-enable capture button based on ID type selection (if already selected) AND camera active
            updateCaptureIdProofButtonState();
            if (personalDetailsVideoStream && personalDetailsVideoStream.active) {
                showMessage(idPictureMessageEl, "Align your ID card within the frame and click 'Capture'.", 'info');
            }
            
            // Show previous step button and set its action for Photo ID Capture
            previousStepNav.style.display = 'block';
            btnBackStep.onclick = recapturePersonalPicture;

            // Show the final 'Next' button when on Photo ID Capture step
            personalDetailsSectionActions.style.display = 'flex';
        }

        function updateCaptureIdProofButtonState() {
            const isIdTypeSelected = identificationType.value !== "";
            // Check if camera stream is active in addition to ID type selected
            if (isIdTypeSelected && personalDetailsVideoStream && personalDetailsVideoStream.active && personalDetailsVideoStream.getTracks().length > 0 && personalDetailsVideoStream.getTracks()[0].enabled) { 
                captureIdProofBtn.disabled = false;
                // Ensure video is visible and placeholder is hidden when camera is active and ID type selected
                videoFeedId.style.display = 'block';
                snapshotImageId.style.display = 'none'; // Hide snapshot if present
                idOutlinePlaceholder.style.display = 'none';
            } else {
                captureIdProofBtn.disabled = true;
                if (!personalDetailsVideoStream || !personalDetailsVideoStream.active || personalDetailsVideoStream.getTracks().length === 0 || !personalDetailsVideoStream.getTracks()[0].enabled) {
                    showMessage(idPictureMessageEl, "Camera not active for ID capture. Please ensure camera is working and try System Setup again.", 'error');
                    videoFeedId.style.display = 'none'; // Hide video if camera not active
                    idOutlinePlaceholder.style.display = 'flex'; // Show placeholder
                    idOutlinePlaceholder.textContent = "Camera not active. Check System Setup.";
                } else if (!isIdTypeSelected) {
                    showMessage(idPictureMessageEl, "Please select an Identification Type to enable capture.", 'error');
                    videoFeedId.style.display = 'block'; // Video still active, but waiting for selection
                    idOutlinePlaceholder.style.display = 'none'; // Video covers placeholder
                }
            }

            recaptureIdProofBtn.disabled = !idProofCaptured;
        }


        async function captureIdProofImage() {
            console.log("captureIdProofImage called.");
            if (identificationType.value === "") {
                showMessage(idPictureMessageEl, "Please select an Identification Type (Aadhaar, Passport, Driver's License, or PAN) before capturing the image.", 'error');
                return;
            }

            if (!takePersonalDetailsSnapshot('video-feed-id', 'snapshot-canvas-id', 'snapshot-image-id', 'id-picture-message')) {
                return;
            }

            const base64ImageData = snapshotCanvasId.toDataURL('image/png').split(',')[1];
            const selectedIdType = identificationType.value;

            showMessage(idPictureMessageEl, "Processing image... Please wait.", 'info');
            captureIdProofBtn.disabled = true;
            recaptureIdProofBtn.disabled = true;
            identificationNumber.value = ''; // Clear previous extraction attempt

            console.log("--- Starting LLM Processing for ID Proof ---");
            console.log("Base64 Image Data Length:", base64ImageData ? base64ImageData.length : 'N/A');
            console.log("Selected ID Type:", selectedIdType);


            try {
                const prompt = `Analyze this image. Does it contain a clear, readable ${selectedIdType} card? If yes, extract the primary identification number from it.
                Return a JSON object with two fields:
                - "isValidId": boolean (true if it's a clear ${selectedIdType} card, false otherwise)
                - "extractedNumber": string (the extracted identification number, or an empty string if not found or not valid ID)`;

                console.log("LLM Prompt:", prompt);

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: "image/png",
                                        data: base64ImageData
                                    }
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "isValidId": { "type": "BOOLEAN" },
                                "extractedNumber": { "type": "STRING" }
                            },
                            "propertyOrdering": ["isValidId", "extractedNumber"]
                        }
                    }
                };

                const apiKey = "AIzaSyDzWPv7Y5neyaigOM0JuamC6nCTMgDQ0_U"; 
                console.log("API Key before fetch:", apiKey); // Log API key for debugging
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log("Raw API Response:", response);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error Response Data:", errorData);
                    throw new Error(`API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const result = await response.json();
                console.log("Parsed LLM Result:", result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    console.log("LLM Raw JSON String:", jsonString);

                    let parsedJson;
                    try {
                        parsedJson = JSON.parse(jsonString);
                        console.log("LLM Parsed JSON Object:", parsedJson);
                    } catch (jsonErr) {
                        console.error("JSON Parsing Error:", jsonErr);
                        throw new Error(`Failed to parse LLM response: ${jsonErr.message}. Response was: ${jsonString}`);
                    }


                    if (parsedJson.isValidId) {
                        idProofCaptured = true;
                        identificationNumber.value = parsedJson.extractedNumber || '';
                        showMessage(idPictureMessageEl, 'Identity proof captured and number extracted!', 'success');
                        captureIdProofBtn.disabled = true;
                        recaptureIdProofBtn.disabled = false;
                    } else {
                        idProofCaptured = false;
                        identificationNumber.value = '';
                        showMessage(idPictureMessageEl, `The captured image does not appear to be a clear ${selectedIdType} card or the number could not be extracted. Please try again.`, 'error');
                        updateCaptureIdProofButtonState();
                        recaptureIdProofBtn.disabled = true;
                        snapshotImageId.style.display = 'none';
                        // Ensure video is back if previously snapshot was shown AND stream is active
                        if (personalDetailsVideoStream && personalDetailsVideoStream.active) {
                            videoFeedId.style.display = 'block';
                            idOutlinePlaceholder.style.display = 'none';
                        } else {
                             videoFeedId.style.display = 'none';
                             idOutlinePlaceholder.style.display = 'flex';
                             idOutlinePlaceholder.textContent = "Camera not active. Check System Setup.";
                        }
                    }
                } else {
                    throw new Error("LLM response structure is unexpected or empty content.");
                }
            } catch (error) {
                console.error("Error during LLM processing:", error);
                showMessage(idPictureMessageEl, `Failed to process image: ${error.message}. Please ensure the image is clear and try again.`, 'error');
                idProofCaptured = false;
                identificationNumber.value = '';
                updateCaptureIdProofButtonState();
                recaptureIdProofBtn.disabled = true;
                snapshotImageId.style.display = 'none';
                // Ensure video is back if previously snapshot was shown AND stream is active
                if (personalDetailsVideoStream && personalDetailsVideoStream.active) {
                    videoFeedId.style.display = 'block';
                    idOutlinePlaceholder.style.display = 'none';
                } else {
                    videoFeedId.style.display = 'none';
                    idOutlinePlaceholder.style.display = 'flex';
                    idOutlinePlaceholder.textContent = "Camera not active. Check System Setup.";
                }
            } finally {
                updatePersonalDetailsOverallNextButtonState(); // Update the overall next button status
            }
            console.log("--- Finished LLM Processing for ID Proof ---");
        }

        function recaptureIdProofImage() {
            idProofCaptured = false;
            identificationNumber.value = '';
            // Re-enable capture button if ID type selected and camera active, show info message
            updateCaptureIdProofButtonState(); 
            recaptureIdProofBtn.disabled = true;
            snapshotImageId.style.display = 'none';
            // Ensure video feed is back
            if (personalDetailsVideoStream && personalDetailsVideoStream.active) {
                videoFeedId.style.display = 'block';
                idOutlinePlaceholder.style.display = 'none';
                showMessage(idPictureMessageEl, 'Ready to recapture your ID proof.', 'info');
            } else {
                videoFeedId.style.display = 'none';
                idOutlinePlaceholder.style.display = 'flex';
                idOutlinePlaceholder.textContent = "Camera not active. Check System Setup.";
                showMessage(idPictureMessageEl, "Camera not active for ID capture. Please ensure camera is working and try System Setup again.", 'error');
            }
            
            updatePersonalDetailsOverallNextButtonState(); // Update the overall next button status
        }


        // --- Upload Resume Logic ---
        function handleResumeFile(files) {
            showMessage(resumeUploadMessageEl, '', '');
            if (files.length > 0) {
                const file = files[0];
                const maxSizeMB = 5;
                const maxSizeBytes = maxSizeMB * 1024 * 1024;

                if (file.size > maxSizeBytes) {
                    showMessage(resumeUploadMessageEl, `File size exceeds ${maxSizeMB}MB. Please upload a smaller file.`, 'error');
                    return;
                }

                showMessage(resumeUploadMessageEl, `File "${file.name}" (${(file.size / 1024 / 1024).toFixed(2)} MB) uploaded successfully!`, 'success');
                console.log('File selected:', file);
            } else {
                showMessage(resumeUploadMessageEl, 'No file selected.', 'error');
            }
        }

        resumeDropArea.addEventListener('dragover', (event) => {
            event.preventDefault();
            resumeDropArea.style.borderColor = '#0078d4';
        });

        resumeDropArea.addEventListener('dragleave', (event) => {
            event.preventDefault();
            resumeDropArea.style.borderColor = '#ccc';
        });

        resumeDropArea.addEventListener('drop', (event) => {
            event.preventDefault();
            resumeDropArea.style.borderColor = '#ccc';
            const files = event.dataTransfer.files;
            handleResumeFile(files);
        });

        resumeDropArea.addEventListener('click', () => {
            resumeFileInput.click();
        });


        // --- Centralized function to update sidebar navigation states ---
        function updateSidebarNavigationStates() {
            // Personal Details nav item enabled only if System Setup is complete
            if (snapshotTaken && !nextToDetailsBtn.disabled) {
                navPersonalDetails.classList.remove('disabled-nav-item');
            } else {
                navPersonalDetails.classList.add('disabled-nav-item');
            }

            // Upload Resume nav item enabled only if Personal Details is complete
            updatePersonalDetailsOverallNextButtonState(); // This function already handles navUploadResume
        }


        // --- Tab and Navigation Logic (System Setup) ---
        function openTab(tabName) {
            // Hide all tab content within System Setup
            document.getElementById('video-check-content').classList.remove('active');
            document.getElementById('audio-check-content').classList.remove('active');
            // Deactivate all tab buttons within System Setup
            document.getElementById('video-check-tab').classList.remove('active');
            document.getElementById('audio-check-tab').classList.remove('active');

            // Activate the requested tab content and button
            document.getElementById(tabName + '-content').classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');

            currentActiveContentId = tabName + '-content';

            // Specific logic for Audio Check tab activation
            if (tabName === 'audio-check') {
                previousStepNav.style.display = 'block';
                btnBackStep.onclick = () => openTab('video-check'); // Set action to go back to video check
                if (currentAudioStream) {
                    currentAudioStream.getTracks().forEach(track => track.stop());
                    currentAudioStream = null;
                }
                if (analyser) analyser.disconnect();
                if (microphoneSource) microphoneSource.disconnect();
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                audioPlayer.style.display = 'none';
                audioPlayer.src = '';
                audioCanvasCtx.clearRect(0, 0, audioWaveformCanvas.width, audioWaveformCanvas.height);

                micConnectionStatusEl.textContent = 'Microphone ready for activation';
                micConnectionStatusEl.className = 'status-text pending';
                startRecordingBtn.disabled = !micDropdown.value; // Disable if no mic selected
                stopPlayRecordingBtn.disabled = true;
                confirmAudioWorksBtn.disabled = true;
                showMessage(audioErrorMessageEl, 'Select a microphone and click "Start Recording" to begin.', 'success');

            } else if (tabName === 'video-check') {
                 previousStepNav.style.display = 'none'; // Hide previous step button on first tab
            }
            // Stop video stream if navigating away from video check
            if (tabName !== 'video-check' && currentVideoStream) {
                currentVideoStream.getTracks().forEach(track => track.stop());
                currentVideoStream = null;
            }
            // Stop audio stream if navigating away from audio check
            if (tabName !== 'audio-check' && currentAudioStream) {
                currentAudioStream.getTracks().forEach(track => track.stop());
                currentAudioStream = null;
                if (analyser) analyser.disconnect();
                if (microphoneSource) microphoneSource.disconnect();
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                audioPlayer.style.display = 'none';
                audioPlayer.src = '';
                audioCanvasCtx.clearRect(0, 0, audioWaveformCanvas.width, audioWaveformCanvas.height);
            }
            // Stop personal details camera if leaving personal details content (although this function is only for System Setup internal tabs)
            if (currentActiveSidebarSectionId !== 'personal-details' && personalDetailsVideoStream) {
                personalDetailsVideoStream.getTracks().forEach(track => track.stop());
                personalDetailsVideoStream = null;
            }
            updateSidebarNavigationStates();
            updatePreviousStepButtonVisibility();
        }

        // --- Master Navigation Function ---
        function navigateTo(sectionId) {
            // First, remove active class from all sidebar items and hide all main content sections
            document.querySelectorAll('.sidebar-nav li').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            let allowNavigation = true;
            let alertMessage = '';
            let fallbackSectionId = currentActiveSidebarSectionId; // Default fallback to current section

            // Navigation Rules:
            // 1. Can only go to Personal Details if System Setup (video & audio) is complete.
            // 2. Can only go to Upload Resume if Personal Details (picture & ID) is complete.
            if (sectionId === 'personal-details') {
                if (nextToDetailsBtn.disabled) { // Check if "Next" button from Audio Check is disabled
                    allowNavigation = false;
                    alertMessage = "Please complete the System Setup (Video and Audio checks) before proceeding to Personal Details.";
                    fallbackSectionId = 'system-setup'; // Suggest going back to system setup
                }
            } else if (sectionId === 'upload-resume') {
                // Ensure System Setup is complete first
                if (nextToDetailsBtn.disabled) {
                    allowNavigation = false;
                    alertMessage = "Please complete the System Setup (Video and Audio checks) before proceeding to Upload Resume.";
                    fallbackSectionId = 'system-setup';
                }
                // Then, ensure Personal Details is complete
                else if (nextFromPersonalDetailsBtn.disabled) { // Check if overall "Next" button in Personal Details is disabled
                    allowNavigation = false;
                    alertMessage = "Please complete the Personal Details section (Picture and ID capture) before proceeding to Upload Resume.";
                    fallbackSectionId = 'personal-details';
                }
            }

            if (!allowNavigation) {
                showModal(alertMessage);
                // Re-activate the current section in sidebar and content
                document.getElementById('nav-' + fallbackSectionId).classList.add('active');
                
                // Show the correct content based on the fallback section
                if (fallbackSectionId === 'system-setup') {
                    document.getElementById('system-setup-content').classList.add('active');
                    document.getElementById('video-check-tab').classList.remove('active'); // Ensure tabs reset
                    document.getElementById('audio-check-tab').classList.remove('active');
                    document.getElementById(currentActiveContentId.replace('-content', '-tab')).classList.add('active'); // Re-activate the last active tab within System Setup
                    document.getElementById(currentActiveContentId).classList.add('active');
                    document.querySelector('.main-content .tabs').style.display = 'flex'; // Show system setup tabs
                } else if (fallbackSectionId === 'personal-details') {
                    document.getElementById('personal-details-content').classList.add('active');
                    // Ensure the current step within Personal Details is visible
                    if (photoIdCaptureStep.style.display !== 'none') {
                        pictureCaptureStep.style.display = 'none';
                        photoIdCaptureStep.style.display = 'flex';
                    } else {
                        pictureCaptureStep.style.display = 'flex';
                        photoIdCaptureStep.style.display = 'none';
                    }
                    document.querySelector('.main-content .tabs').style.display = 'none'; // Hide system setup tabs
                }
                currentActiveSidebarSectionId = fallbackSectionId;
                // Ensure previous step button state is correct after falling back
                updatePreviousStepButtonVisibility();
                return;
            }

            // If navigation is allowed, proceed to activate the new section
            document.getElementById('nav-' + sectionId).classList.add('active');
            currentActiveSidebarSectionId = sectionId;

            const tabsContainerSystemSetup = document.querySelector('.main-content .tabs'); // Original tabs for System Setup
            const mainHeader = document.querySelector('.main-content .main-header');

            // Set main header text based on section
            if (sectionId === 'system-setup') {
                mainHeader.textContent = 'System Setup';
                tabsContainerSystemSetup.style.display = 'flex'; // Show System Setup tabs
                document.getElementById('system-setup-content').classList.add('active');
                openTab('video-check'); // Default to video check for system setup
            } else if (sectionId === 'personal-details') {
                mainHeader.textContent = 'Personal Details';
                tabsContainerSystemSetup.style.display = 'none'; // Hide System Setup tabs
                document.getElementById('personal-details-content').classList.add('active'); // Set active
                initPersonalDetailsCameras(); // Initialize cameras and set first step active
            } else if (sectionId === 'upload-resume') {
                mainHeader.textContent = 'Upload Resume';
                tabsContainerSystemSetup.style.display = 'none'; // Hide System Setup tabs
                document.getElementById('upload-resume-content').classList.add('active'); // Set active
            }

            // Stop relevant media streams when navigating away from their sections
            if (sectionId !== 'system-setup') {
                if (currentVideoStream) {
                    currentVideoStream.getTracks().forEach(track => track.stop());
                    currentVideoStream = null;
                }
                if (currentAudioStream) {
                    currentAudioStream.getTracks().forEach(track => track.stop());
                    currentAudioStream = null;
                }
                if (analyser) analyser.disconnect();
                if (microphoneSource) microphoneSource.disconnect();
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
                audioPlayer.style.display = 'none';
                audioPlayer.src = '';
                audioCanvasCtx.clearRect(0, 0, audioWaveformCanvas.width, audioWaveformCanvas.height);
            }
            if (sectionId !== 'personal-details') {
                if (personalDetailsVideoStream) {
                    personalDetailsVideoStream.getTracks().forEach(track => track.stop());
                    personalDetailsVideoStream = null;
                }
            }
            updateSidebarNavigationStates();
            updatePreviousStepButtonVisibility(); // Update visibility after full navigation
        }

        // Function to control visibility and action of the "Previous Step" button
        function updatePreviousStepButtonVisibility() {
            if (currentActiveSidebarSectionId === 'system-setup') {
                if (currentActiveContentId === 'audio-check-content') {
                    previousStepNav.style.display = 'block';
                    btnBackStep.onclick = () => openTab('video-check');
                } else {
                    previousStepNav.style.display = 'none';
                }
            } else if (currentActiveSidebarSectionId === 'personal-details') {
                if (photoIdCaptureStep.style.display !== 'none') { // If Photo ID Capture is active
                    previousStepNav.style.display = 'block';
                    btnBackStep.onclick = recapturePersonalPicture;
                } else { // If Picture Capture is active (first step)
                    previousStepNav.style.display = 'none';
                }
            } else {
                previousStepNav.style.display = 'none';
            }
        }


        function goToAudioCheck() {
            if (!nextToAudioBtn.disabled) {
                openTab('audio-check');
            }
        }

        function goToPersonalDetails() {
            navigateTo('personal-details');
        }

        // This function will now be called by the "Next" button in "Upload Resume" section
        function proceedToInterview() {
            // Stop all active media streams (cameras, microphones, recordings)
            if (currentVideoStream) {
                currentVideoStream.getTracks().forEach(track => track.stop());
                currentVideoStream = null;
            }
            if (currentAudioStream) {
                currentAudioStream.getTracks().forEach(track => track.stop());
                currentAudioStream = null;
            }
            if (personalDetailsVideoStream) {
                personalDetailsVideoStream.getTracks().forEach(track => track.stop());
                personalDetailsVideoStream = null;
            }
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            // Redirect to the join-interview page
            window.location.href = '/join-interview/';
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.createElement('canvas');
            canvas.id = 'snapshot-canvas';
            canvas.style.display = 'none';
            document.body.appendChild(canvas);

            const customModalDiv = document.createElement('div');
            customModalDiv.id = 'customModal';
            customModalDiv.style.display = 'none';
            document.body.appendChild(customModalDiv);

            getMediaDevices();
            // Start on System Setup / Video Check
            navigateTo('system-setup');

            // Initial button states for System Setup (video/audio)
            confirmLooksGoodBtn.disabled = true;
            confirmAudioWorksBtn.disabled = true;
            startRecordingBtn.disabled = true;
            stopPlayRecordingBtn.disabled = true;

            // Initial button states for Personal Details
            captureIdProofBtn.disabled = true;
            recaptureIdProofBtn.disabled = true;
            nextToIdCaptureBtn.disabled = true; // New button in Personal Details step 1

            identificationType.addEventListener('change', () => {
                updateCaptureIdProofButtonState();
                if (identificationType.value !== "") {
                    showMessage(idPictureMessageEl, "Align your ID card within the frame and click 'Capture'.", 'info');
                } else {
                    showMessage(idPictureMessageEl, "Please select an Identification Type to enable capture.", 'error');
                }
            });

            identificationNumber.setAttribute('readonly', 'readonly');
            identificationNumber.placeholder = "Number will be auto-extracted";

            updateSidebarNavigationStates();
            updatePreviousStepButtonVisibility(); // Call on initial load to set state
        });
    </script>
</body>
</html>
