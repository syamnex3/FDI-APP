<!DOCTYPE html>
<html lang="en">
<head>
     {% load static %}
    <link rel="shortcut icon" href="{% static 'favicon.ico' %}">

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment Questions</title>
    <!-- Link to Google Fonts for Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Universal box-sizing for consistent layout */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* --- Animation Keyframes --- */
        @keyframes pageFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes cardFadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        /* --- Header.html specific CSS for consistent header appearance --- */
        /* Fixed top header for consistent placement */
        .top-header {
            position: fixed;
            top: 0; /* Ensure it's at the very top */
            left: 0; /* Extend to the full left side */
            width: 100%; /* Occupy full width */
            z-index: 1000; /* High z-index to stay on top */
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: left var(--transition-duration) ease, width var(--transition-duration) ease; /* Smooth transition for sidebar collapse (though less relevant now) */
        }

        /* Brand title section - dark blue bar at the very top */
        .brand-title {
            background-color: #1d2686;
            color: #fff;
            font-size: 20px; /* Reduced font size */
            padding: 9px 12px; /* Adjusted padding to match sidebar left/right alignment */
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Text within the brand title */
        .brand-title-text {
            color: #fff;
            font-size: 20px; /* Reduced font size */
            font-weight: bold;
        }

        /* Container for top-right icons for consistent spacing */
        .header-top-icons {
            display: flex;
            align-items: center;
            gap: 20px; /* Equal spacing between icons */
        }

        /* Main header below the top bar */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 10px; /* Adjusted padding to match sidebar left/right alignment */
            border-bottom: 1px solid #eee;
        }

        /* Breadcrumb navigation */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0;
            font-size: 10px; /* Reduced font size */
            color: #999;
        }

        /* "Back" link in breadcrumb */
        .breadcrumb-link {
            padding: 5px 10px; /* Reduced padding */
            cursor: pointer;
            color: #1d2686;
            font-size: 12px; /* Reduced font size */
            transition: 0.2s ease;
            margin-right: 8px; /* Reduced gap after "Back" button */
            margin-left: -10px; /* Adjusted position */
        }

        /* Headings within the breadcrumb */
        .breadcrumb-heading {
            color: #999;
            text-decoration: none;
            transition: color 0.2s;
            font-size: 12px; /* Reduced font size */
        }
        
        .breadcrumb-heading.active {
            color: #1d2686;
            font-weight: bold;
        }

        .breadcrumb-heading:hover {
            color: #1d2686;
        }

        /* Separator icon in breadcrumb ('>') */
        .breadcrumb-separator {
            font-size: 16px; /* Reduced font size for the icon */
            color: #ccc;
            margin-left: 4px; /* Reduced margin */
            margin-right: 4px; /* Reduced margin */
            font-weight: normal;
        }

        /* Status section (Active, Candidate, Invite) */
        .status {
            display: flex;
            align-items: center;
            gap: 20px; /* Adjusted gap */
            font-size: 13px; /* Adjusted font size for status text */
            margin-left: auto; /* Pushes the status block to the right */
        }

        /* Active dot indicator */
        .status .active-dot {
            width: 8px; /* Reduced size */
            height: 8px; /* Reduced size */
            background-color: #28a745;
            border-radius: 50%;
            display: inline-block;
        }

        /* Invite button */
        .invite-btn {
            background-color: #28a745;
            color: #fff;
            border: none;
            margin-right:-5px;
            padding: 4px 12px 4px 12px; /* Reduced padding for a smaller button */
            font-weight: 600;
            font-size: 13px; /* Reduced font size */
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            }
        .invite-btn:hover {
            background-color: #218838;
        }

        /* Profile Menu Container (S, dropdown arrow) */
        .profile-menu-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px; /* Reduced gap */
            cursor: pointer;
            color: #fff;
            font-weight: bold;
        }

        /* Profile avatar (the 'S' circle) */
        .profile-avatar {
            width: 28px; /* Reduced size */
            height: 28px; /* Reduced size */
            border-radius: 50%;
            background-color: #e0e0e0;
            color: #1d2686;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px; /* Reduced font size */
            text-transform: uppercase;
        }

        /* Styles for the new question mark icon next to 'S' */
        .profile-help-icon {
            color: #fff; /* White color for the question mark icon */
            font-size: 20px; /* Increased font size for visual weight to match 'S' visually */
            width: 28px; /* Matched width with .profile-avatar */
            height: 28px; /* Matched height with .profile-avatar */
            border-radius: 6px; /* Slightly rounded corners for the square */
            display: flex; /* Use flex to center the icon */
            justify-content: center; /* Center horizontally */
            align-items: center;
            cursor: pointer;
        }
        /* Styles for the new education icon (not present in current HTML, but kept for consistency) */
        .profile-education-icon {
            color: #fff; /* White color for the education icon */
            font-size: 20px; /* Matched font size with help icon */
            width: 28px; /* Matched width with help icon */
            height: 28px; /* Matched height with help icon */
            border-radius: 6px; /* Matched border-radius with help icon */
            display: flex;
            justify-content: center;
            align-items: center;
            margin-left: 5px; /* Small margin from the previous icon */
            cursor: pointer;
        }


        /* Profile dropdown menu */
        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            overflow: hidden;
            min-width: 200px; /* Slightly reduced width */
            display: none;
            z-index: 100;
            margin-top: 8px; /* Reduced gap */
            font-family: 'Inter', sans-serif;
            animation: pageFadeIn 0.2s ease-out;
        }

        .profile-dropdown.show {
            display: block;
        }

        /* Header within the dropdown (Sri, email, company) */
        .profile-dropdown-header {
            padding: 8px 12px; /* Reduced padding */
            background-color: #f0f2f5;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            color: #333;
        }

        .profile-dropdown-header span {
            font-size: 14px; /* Reduced font size */
        }

        .profile-dropdown-header small {
            color: #666;
            font-weight: 400;
            font-size: 11px; /* Reduced font size */
        }

        /* Individual items in the dropdown menu */
        .profile-dropdown-item {
            padding: 8px 12px; /* Reduced padding */
            display: flex;
            align-items: center;
            gap: 8px; /* Reduced gap */
            text-decoration: none;
            color: #333;
            font-weight: 500;
            font-size: 12px; /* Reduced font size */
            transition: background-color 0.2s;
        }

        .profile-dropdown-item:hover {
            background-color: #f5f5f5;
        }

        .profile-dropdown-item i {
            color: #1d2686;
        }

        /* --- Cart Icon and Count Styles (Header) --- */
        .cart-icon-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: #fff;
            font-weight: bold;
        }

        .cart-icon-container .fa-list { /* Explicitly target fa-list */
            font-size: 20px;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .cart-item-count {
            position: absolute;
            top: -8px;
            right: -10px;
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
        }

        /* --- Modal Styles (Cart & Add Question, copied from pythonAdvancedAssessment.html) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1001;
            display: none;
            align-items: center;
            justify-content: center;
            animation: pageFadeIn 0.3s ease;
        }

        .modal-content {
            background-color: #fff;
            border-radius: var(--border-radius-md);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px; /* Max width for modal */
            max-height: 85vh; /* Max height for modal */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: cardFadeInUp 0.4s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color-light);
            background-color: #f7f7f7;
        }

        .modal-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }
        .cart-modal-header h3 .item-count-indicator {
            font-weight: normal;
            color: var(--text-color-muted);
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-color-muted);
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s ease;
        }
        .modal-close-btn:hover {
            color: var(--text-color-dark);
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }
        .modal-body .form-group {
            margin-bottom: 15px;
        }
        .modal-body .form-group label {
            display: block;
            font-size: 13px;
            color: var(--text-color-muted);
            margin-bottom: 5px;
            font-weight: 600;
        }
        .modal-body .form-group input[type="text"],
        .modal-body .form-group input[type="number"],
        .modal-body .form-group textarea,
        .modal-body .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color-medium);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            font-family: var(--font-family-sans);
            transition: border-color 0.2s ease;
        }
        .modal-body .form-group input:focus,
        .modal-body .form-group textarea:focus,
        .modal-body .form-group select:focus {
            outline: none;
            border-color: var(--primary-color-light);
        }

        .modal-body .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .cart-modal-item-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .cart-modal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color-light);
            font-size: 14px;
        }
        .cart-modal-item:last-child {
            border-bottom: none;
        }

        .cart-modal-item-text {
            flex-grow: 1;
            margin-right: 10px;
            color: var(--text-color-dark);
            font-size: 13px;
        }
        .cart-modal-item-text .item-q-number {
             font-weight: bold;
             color: var(--primary-color);
             margin-right: 5px;
        }


        .cart-modal-item-remove-btn {
            background: none;
            border: none;
            color: #dc3545; /* danger-color directly for consistency */
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .cart-modal-item-remove-btn:hover {
            color: #a71d2a;
            transform: scale(1.1);
        }


        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color-light);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            background-color: #f7f7f7;
            gap: 10px;
        }
        .cart-modal-footer {
             justify-content: space-between;
        }

        /* Updated .action-button-modal for larger size */
        .modal-footer .action-button-modal {
            border: none;
            padding: 12px 25px; /* Increased padding for larger size */
            border-radius: var(--border-radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            font-size: 16px; /* Slightly larger font */
            min-width: 180px; /* Ensure a decent width */
            text-align: center;
        }
        .modal-footer .action-button-modal:active {
            transform: scale(0.98);
        }

        .cart-modal-footer .clear-list-btn {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        .cart-modal-footer .clear-list-btn:hover {
            background-color: var(--primary-color-light);
            color: var(--text-color-light);
            border-color: var(--primary-color-light);
        }

        .modal-footer .save-btn,
        .cart-modal-footer .create-assessment-btn {
            background-color: #28a745; /* success-color directly */
            color: var(--text-color-light);
        }
        .modal-footer .save-btn:hover,
        .cart-modal-footer .create-assessment-btn:hover {
            background-color: #218838;
        }
        .cart-modal-footer .create-assessment-btn.disabled {
            background-color: #aaa;
            cursor: not-allowed;
            transform: none;
        }
        .modal-footer .cancel-btn {
            background-color: #6c757d;
            color: var(--text-color-light);
        }
        .modal-footer .cancel-btn:hover {
            background-color: #5a6268;
        }


        /* --- QuestionPage.html specific CSS --- */
        /* CSS Variables for consistent styling */
        :root {
            --font-family-sans: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --primary-color: #1d2686; /* Dark Blue */
            --primary-color-light: #3b4cdc; /* Lighter Blue */
            --premium-color: #e8a800; /* Gold for premium items */
            --premium-text-color: #B71C1C; /* Darker Red for premium text on image */
            --premium-overlay-bg: rgba(255, 255, 255, 0.95); /* Slightly more opaque white for overlay box */
            --text-color-light: #fff;
            --text-color-dark: #333;
            --text-color-muted: #999;
            --text-color-sidebar: #e0e0e0; /* Light grey on dark background */
            --text-color-sidebar-hover: #ffffff; /* White on hover */
            --text-color-sidebar-accent: #87CEFA; /* LightSkyBlue for accents */
            --success-color: #28a745; /* Green for success */
            --danger-color: #dc3545; /* Added danger color for consistency */

            --bg-color-page: #f9fafc; /* Light background for main content */
            --bg-color-header: #fff; /* White background for header */
            --bg-color-sidebar: #1a1a1a; /* Slightly darker black for sidebar */
            --bg-color-sidebar-input: #2c2c2c; /* Darker grey for input fields */
            --border-color-light: #eee; /* Light border */
            --border-color-medium: #ddd; /* Added medium border color for modal */
            --border-radius-sm: 4px;
            --border-radius-md: 6px;

            /* Header height calculation (based on header.html elements: 40px for brand-title + 26px for header) */
            --total-header-height: 66px;

            /* Default sidebar and content widths */
            --sidebar-width: 300px;
            --sidebar-padding-x: 20px;

            /* Collapsed sidebar width */
            --sidebar-width-collapsed: 80px;
            --sidebar-padding-x-collapsed: 10px;

            /* Transition duration */
            --transition-duration: 0.3s;
        }

        /* Base body styles with smaller font and Inter font family */
        body {
            font-family: var(--font-family-sans);
            background-color: var(--bg-color-page);
            color: var(--text-color-dark);
            display: flex;
            padding-left: var(--sidebar-width); /* Initial padding for sidebar */
            padding-top: var(--total-header-height); /* Initial padding for fixed header */
            line-height: 1.6;
            min-height: 100vh;
            transition: padding-left var(--transition-duration) ease;
            animation: pageFadeIn 0.5s ease-in-out;
        }

        body.sidebar-collapsed {
             padding-left: var(--sidebar-width-collapsed);
        }

        /* No specific changes for collapsed sidebar on top-header if it spans full width */
        /* body.sidebar-collapsed .top-header {
            left: var(--sidebar-width-collapsed);
            width: calc(100% - var(--sidebar-width-collapsed));
        } */

        /* Styles for the skip mode */
        body.skip-active {
            padding-left: 0 !important; /* Remove sidebar padding when skip is active, ensure it overrides JS */
            cursor: not-allowed; /* Block cursor for the entire body when skip is active */
        }

        body.skip-active .left-sidebar,
        body.skip-active .right-content-header,
        body.skip-active .right-content-body-wrapper {
            display: none !important; /* Hide these elements in skip mode */
        }
        /* Ensure right-content itself is a flex container and centers its content */
        body.skip-active .right-content {
            display: flex !important;
            flex-direction: column !important;
            justify-content: center !important;
            align-items: center !important;
            padding-left: 0 !important;
            margin-left: 0 !important;
        }


        body.skip-active .skip-selection-container {
            display: flex !important; /* Show the skip selection container */
            flex-direction: row !important; /* Forces row direction even on small screens */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            flex-grow: 1; /* Take up available space */
            padding: 20px;
            text-align: center;
            height: calc(100vh - var(--total-header-height)); /* Ensure it fills the height */
            gap: 40px; /* Space between the two options */
            width: 100%; /* Ensure it takes full width when other elements are hidden */
            margin-left: 0; /* Reset any potential margin from sidebar */
        }


        .left-sidebar {
            width: var(--sidebar-width);
            flex-shrink: 0; /* Prevent sidebar from shrinking */
            background-color: var(--bg-color-sidebar);
            color: var(--text-color-sidebar);
            position: fixed; /* Fixed position */
            top: var(--total-header-height); /* Position below the header */
            left: 0;
            height: calc(100vh - var(--total-header-height)); /* Full height minus header */
            overflow-y: auto; /* Scroll if content overflows */
            border-right: 1px solid var(--border-color-dark);
            padding: 20px var(--sidebar-padding-x);
            display: flex;
            flex-direction: column;
            gap: 15px; /* Spacing between sidebar items */
            transition: width var(--transition-duration) ease, padding var(--transition-duration) ease, transform var(--transition-duration) ease;
            z-index: 900; /* Below header but above main content if overlapping */
        }

        body.sidebar-collapsed .left-sidebar {
            width: var(--sidebar-width-collapsed);
            padding: 20px var(--sidebar-padding-x-collapsed);
            overflow-x: hidden; /* Hide horizontal overflow when collapsed */
        }

        /* Hide scrollbar for left-sidebar */
        .left-sidebar::-webkit-scrollbar { display: none; }
        .left-sidebar { scrollbar-width: none; -ms-overflow-style: none; }

        /* Custom scrollbar for right-content */
        .right-content::-webkit-scrollbar { width: 8px; }
        .right-content::-webkit-scrollbar-thumb { background-color: #555; border-radius: var(--border-radius-sm); }
        .right-content::-webkit-scrollbar-track { background-color: var(--bg-color-page); }
        .right-content { scrollbar-width: thin; scrollbar-color: #555 var(--bg-color-page); }


        .right-content {
            flex-grow: 1; /* Take remaining space */
            padding: 0; /* Padding will be on inner elements */
            height: calc(100vh - var(--total-header-height));
            overflow-y: auto; /* Scroll if content overflows */
            display: flex;
            flex-direction: column;
        }

        .right-content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding: 15px 15px ; /* Adjusted padding-top and padding-bottom here */
            background-color: var(--bg-color-header);
            border-bottom: 1px solid var(--border-color-light);
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        .question-count span {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color-dark);
        }

        .sort-by-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-color-muted);
        }

        .sort-by-display-value {
            font-weight: 600;
            color: var(--primary-color);
        }

        .skip-button {
            background: none;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 4px 12px;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.2s ease, color 0.2s ease;
            margin-left: 20px; /* Space from sort-by */
        }

        .skip-button:hover {
            background-color: var(--primary-color);
            color: var(--text-color-light);
        }

        .right-content-body-wrapper {
            padding: 0 20px 20px; /* Removed padding-top, kept horizontal and bottom padding */
            flex-grow: 1; /* Allow this wrapper to grow and scroll */
            overflow-y: auto; /* Ensure this part scrolls if content is too long */
        }

        .selected-filters-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color-light);
        }

        .selected-filter-tag {
            background-color: var(--primary-color-light);
            color: var(--text-color-light);
            padding: 2px 6px;
            font-size: 12px;
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            gap: 3px;
            height: 20px; /* Fixed height for alignment */
            animation: cardFadeInUp 0.3s ease;
        }

        .selected-filter-tag .remove-tag {
            cursor: pointer;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.8);
            transition: color 0.2s ease;
        }
        .selected-filter-tag .remove-tag:hover {
            color: var(--text-color-light);
        }


        .behavior-check-container {
            margin-top: 20px; /* Space from top of sidebar */
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color-dark);
            display: flex;
            align-items: center;
        }

        .behavior-check {
            font-weight: bold;
            font-size: 18px;
            color: var(--text-color-light);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            white-space: nowrap; /* Prevent text wrapping */
            overflow: hidden; /* Hide overflowed text */
            text-overflow: ellipsis; /* Show ellipsis for overflow */
        }
        body.sidebar-collapsed .behavior-check .behavior-check-text { display: none; }

        body.sidebar-collapsed .behavior-check-container {
            justify-content: center; /* Center icon when collapsed */
            padding-right: 0;
            border-bottom: none; /* Remove border when collapsed and centered */
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .sidebar-collapsible-content {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Consistent gap */
            transition: opacity 0.3s ease;
        }
        body.sidebar-collapsed .sidebar-collapsible-content { 
            opacity: 0;
            pointer-events: none;
        }


        .filter-and-sort {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: bold;
            color: var(--text-color-sidebar);
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color-dark);
            border-radius: var(--border-radius-sm);
            background-color: var(--bg-color-sidebar-input);
            color: var(--text-color-sidebar);
            font-size: 14px;
            outline: none; /* Remove default outline */
            transition: border-color 0.2s ease;
        }
        .search-box input:focus { border-color: var(--primary-color-light); }
        .search-box input::placeholder { color: #888; }


        .clear-all-filters-btn {
            background: none; border: none;
            color: var(--text-color-sidebar-accent);
            cursor: pointer; font-size: 14px; font-weight: bold;
            padding: 0; white-space: nowrap;
            transition: color 0.2s ease;
        }
        .clear-all-filters-btn:hover { 
            text-decoration: underline; 
            color: var(--text-color-sidebar-hover);
        }

        .filter-section h3 {
            font-size: 16px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
            color: var(--text-color-sidebar); cursor: pointer;
        }
        .filter-section h3 .filter-title-text { display: flex; align-items: center; gap: 8px; }
        .filter-section h3 button.toggle-btn {
            border: none; background: none; font-size: 20px;
            color: var(--text-color-sidebar-accent); cursor: pointer;
            padding: 0 5px; line-height: 1; /* Ensure button icon is aligned */
            transition: transform 0.3s ease;
        }
        .filter-section.active h3 button.toggle-btn {
            transform: rotate(45deg);
        }

        .filter-section ul {
            list-style: none; padding: 0; margin: 0;
            overflow: hidden; /* Important for max-height transition */
            transition: max-height var(--transition-duration) ease, opacity var(--transition-duration) ease;
            max-height: 0; opacity: 0; pointer-events: none; /* Prevent interaction when collapsed */
        }
        .filter-section.active ul {
            max-height: 1000px; /* Large enough to accommodate content */
            opacity: 1; pointer-events: auto;
        }

        .filter-section ul ul { /* Nested lists */
            padding-left: 15px; margin-top: 5px;
            /* These should always be visible if parent is active, no separate transition */
            max-height: none; opacity: 1; pointer-events: auto; transition: none;
        }

        .filter-section ul.two-column { display: flex; flex-wrap: wrap; gap: 0 10px; }
        .filter-section.active ul.two-column { display: flex; } /* Ensure display:flex when active */
        .filter-section ul.two-column li { width: calc(50% - 5px); } /* For two columns */

        .filter-section ul li label {
            display: block; /* Make label take full width for easier clicking */
            padding: 4px 0;
            cursor: pointer;
            color: var(--text-color-sidebar);
            transition: color 0.2s ease;
        }
        .filter-section ul li label:hover { color: var(--text-color-sidebar-hover); }
        .filter-section ul li input[type="checkbox"],
        .filter-section ul li input[type="radio"] {
            margin-right: 8px;
            accent-color: var(--primary-color-light); /* Style checkbox/radio color */
        }


        .view-more-btn {
            background: none; border: none;
            color: var(--text-color-sidebar-accent); cursor: pointer;
            font-size: 14px; font-weight: bold;
            padding: 5px 0; margin-top: 8px; text-align: left;
            display: none; /* Initially hidden, JS will show if needed */
            transition: color 0.2s ease;
        }
        .view-more-btn:hover { 
            text-decoration: underline; 
            color: var(--text-color-sidebar-hover);
        }

        .hidden-item { display: none !important; } /* Important to override other display styles */


        .assessment-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Responsive grid */
            gap: 20px;
            margin-top: 20px; /* Changed from padding-top to margin-top */
        }

        /* Styles for assessment card from dummy.question.html */
        .assessment-card {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: var(--border-radius-md);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease; /* Added border-color to transition */
            opacity: 0; /* Initial state for animation */
            animation: cardFadeInUp 0.5s ease-out forwards;
        }
        .assessment-card:not(.premium-card) {
            cursor: pointer;
        }
        .premium-card {
            cursor: default;
        }
        .assessment-card:hover:not(.premium-card) {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon { /* Renamed from .card-header .card-icon for clarity */
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #28a745; /* Default, can be overridden by domain */
            color: var(--text-color-light);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .card-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-color);
            flex-grow: 1; /* Allows title to take available space */
            font-family: Calibri, sans-serif; /* Applied Calibri font */
        }
        .card-description {
            font-size: 13px;
            color: var(--text-color-dark);
            margin-top: -5px; /* Adjust spacing to title */
            line-height: 1.4;
            max-height: 4.2em; /* Approximately 3 lines of text */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Limit to 3 lines */
            line-clamp: 3; /* Standard property for compatibility */
            -webkit-box-orient: vertical;
            font-family: Calibri, sans-serif; /* Applied Calibri font */
        }

        .card-external-link {
            color: var(--primary-color);
            font-size: 16px;
            text-decoration: none;
            transition: color 0.2s ease;
            margin-left: auto; /* Pushes icon to the right */
        }
        .card-external-link:hover {
            color: var(--primary-color-light);
        }
        .premium-card .card-external-link {
            color: var(--text-color-muted);
            pointer-events: none;
            cursor: default;
        }
        .premium-card .card-external-link i {
            opacity: 0.5;
        }

        .card-meta {
            font-size: 12px;
            color: var(--text-color-muted);
            font-family: Calibri, sans-serif; /* Applied Calibri font */
        }
        .card-meta .tech-tag { /* For domain tag like Tech/Non-Tech */
            background-color: #28a740; /* Default for Tech */
            color: var(--text-color-light);
            padding: 2px 6px;
            border-radius: var(--border-radius-sm);
            font-weight: bold;
            margin-left: 8px;
        }
        .card-meta.premium-description {
            color: var(--text-color-dark);
            font-weight: normal;
            font-size: 12px;
            text-align: left;
            margin-top: 5px;
            line-height: 1.4;
            font-family: Calibri, sans-serif; /* Applied Calibri font */
        }

        .card-image-placeholder {
            width: 100%;
            height: 120px;
            background-color: #f0f0f0;
            border-radius: var(--border-radius-sm);
            display: flex;
            flex-direction: column; /* Ensure content inside placeholder can be stacked if needed */
            justify-content: center;
            align-items: center;
            color: var(--text-color-muted);
            font-size: 14px;
            overflow: hidden; /* Ensures image and overlays stay within bounds */
            position: relative; /* For absolute positioning of img and overlays */
        }

        .card-image-placeholder img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures image covers the area, might crop */
            z-index: 1; /* Image below overlays */
            transition: filter 0.3s ease;
        }
        .premium-card .card-image-placeholder img {
            filter: blur(2px) grayscale(50%);
        }

        .premium-image-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--premium-overlay-bg);
            border: 1px solid var(--premium-color);
            border-radius: var(--border-radius-md);
            padding: 10px 15px;
            z-index: 3; /* Above image and tech tags overlay */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            text-align: center;
        }
        .premium-image-overlay .lock-icon {
            color: var(--premium-color);
            font-size: 24px;
        }
        .premium-image-overlay .premium-text {
            color: var(--premium-text-color);
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            font-family: Calibri, sans-serif; /* Applied Calibri font */
        }

        .card-tech-tags-overlay { /* For tags like JavaScript, Oops, etc. on the image */
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            z-index: 2; /* Above image, below premium overlay */
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
        }
        .premium-card .card-tech-tags-overlay {
            display: none; /* Hide tech tags overlay on premium cards if premium overlay is shown */
        }
        .card-tech-tags-overlay span {
            background-color: rgba(255, 255, 255, 0.8);
            color: var(--text-color-dark);
            padding: 2px 8px;
            border-radius: var(--border-radius-sm);
            font-size: 11px;
            font-weight: bold;
            font-family: Calibri, sans-serif; /* Applied Calibri font */
        }
        
        /* REVERTED: Styles for card footer */
        .card-footer {
            display: flex;
            justify-content: center; /* Reverted to center */
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid #eee;
            margin-top: auto; /* Pushes footer to bottom of card */
            font-family: Calibri, sans-serif;
        }

        .card-footer .action-button { /* Unified class for both customize and upgrade */
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            background-color: transparent;
            padding: 4px 10px;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background-color 0.2s ease, color 0.2s ease;
            text-transform: uppercase;
            text-decoration: none; /* For anchor tags used as buttons */
        }
        .card-footer .action-button:hover {
            background-color: var(--primary-color);
            color: var(--text-color-light);
        }

        .card-footer .upgrade-button { /* Specific style for upgrade */
            background-color: var(--premium-color);
            color: white;
            border-color: var(--premium-color);
        }
        .card-footer .upgrade-button:hover {
            background-color: #d48f00; /* Darker gold */
            border-color: #d48f00;
        }
        .created-on-date { /* Style from dummy.question.html */
            font-size: 11px;
            color: #777;
            margin-top: 5px; /* Added some margin for spacing */
            margin-bottom: 5px; /* Added margin for spacing below it */
            font-family: Calibri, sans-serif; /* Applied Calibri font */
        }

        /* Styles for the new skip selection container */
        .skip-selection-container {
            display: none; /* Hidden by default */
            width: 100%;
            max-width: 900px; /* Limit width for better appearance */
            margin: auto; /* Center horizontally */
        }

        .skip-option-card {
            background-color: #fff;
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius-md);
            padding: 20px;
            
            flex: 1; /* Take equal space */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        /* Ensure text within skip option card doesn't wrap */
        .skip-option-card .skip-card-text {
            white-space: nowrap;
        }

        .skip-option-card:hover {
            background-color: var(--primary-color);
            color: var(--text-color-light);
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .skip-option-card i {
            margin-bottom: 15px;
            font-size: 40px;
        }


        @media (max-width: 768px) {
            body {
                flex-direction: column;
                padding-left: 0 !important; /* Override JS inline style for sidebar padding */
                padding-top: var(--total-header-height); /* Keep header padding */
            }
            body.skip-active {
                 padding-top: var(--total-header-height) !important; /* Ensure header padding is maintained in skip mode */
            }

            .top-header {
                position: fixed; /* Ensure it stays fixed on mobile */
                left: 0; /* Full width on mobile, no sidebar offset */
                width: 100%;
            }

            .left-sidebar {
                width: 100%; height: auto; position: static; /* Change to static for mobile */
                border-right: none; border-bottom: 1px solid var(--border-color-dark);
                padding: 20px; transition: none; /* No transition needed for static layout */
                z-index: auto; /* Reset z-index for static flow */
            }
            body.sidebar-collapsed .left-sidebar {
                width: 100%; padding: 20px; /* No change for collapsed on mobile */
            }

            .right-content {
                width: 100%; height: auto; /* Adjust height for mobile flow */
                transition: none;
            }

            /* Adjust header navigation for smaller screens */
            .top-header .header { /* Target the inner header div from header.html */
                flex-direction: column;
                align-items: flex-start;
                padding-bottom: 10px;
            }

            .top-header .breadcrumb { /* Target the breadcrumb from header.html */
                margin-bottom: 10px;
                flex-wrap: wrap; /* Allow breadcrumbs to wrap */
            }
            .top-header .status { /* Target the status section from header.html */
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }

            /* Ensure sidebar content is always visible on mobile, regardless of collapsed state */
            .sidebar-collapsible-content {
                display: flex !important; /* Override JS inline style */
                max-height: none !important; /* Allow full height */
                opacity: 1 !important;
                pointer-events: auto !important;
            }
            /* Ensure text next to hamburger is shown on mobile */
            body.sidebar-collapsed .behavior-check .behavior-check-text { display: inline; }
            .behavior-check-container { justify-content: flex-start !important; } /* Align to start on mobile */


            .right-content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .sort-by-container {
                width: 100%;
                justify-content: space-between;
            }
            .skip-button { margin-left: 0; margin-top: 10px; width: 100%; text-align: center;}


            /* Skip selection on mobile */
            body.skip-active .skip-selection-container {
                flex-direction: row !important; /* Forces row direction on mobile too */
                gap: 20px;
                height: calc(100vh - var(--total-header-height) - 40px); /* Adjust height considering padding */
                padding: 20px;
            }

            /* Cart Modal Responsive */
            .modal-content {
                max-width: 95%; /* Adjust for smaller screens */
            }
            .cart-modal-footer {
                flex-direction: column;
                gap: 10px;
            }
            .modal-footer .action-button-modal {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Integrated Header from header.html -->
    <div class="top-header">
        <!-- Top bar with FDI and Profile -->
        <div class="brand-title">
            <span class="brand-title-text">FDI</span>
            <!-- Profile Menu Section, Cart Icon, and Help Icon -->
            <div class="header-top-icons">
                <div class="profile-menu-container" id="profileMenuContainer">
                    <div class="profile-avatar">S</div> <!-- Initial for 'Sri' -->
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="profile-dropdown-header">
                            <span>Sri</span><br>
                            <small>srharshak@nexnoratech.onmicros....</small><br>
                            <small>Nexnoratech</small>
                        </div>
                        <a href="/company-profile/" class="profile-dropdown-item">
                            <i class="fas fa-building"></i> Company Profile
                        </a>
                        <a href="team-members/" class="profile-dropdown-item">
                            <i class="fas fa-users"></i> Team Members
                        </a>
                        <a href="#" class="profile-dropdown-item">
                            <i class="fas fa-envelope"></i> Email Templates
                        </a>
                        <a href="/question-library/" class="profile-dropdown-item">
                            <i class="fas fa-question-circle"></i> Connect Question Library
                        </a>
                        <a href="#" class="profile-dropdown-item">
                            <i class="fas fa-chart-bar"></i> Plan Usage
                        </a>
                        <a href="/setting/" class="profile-dropdown-item">
                            <i class="fas fa-cog"></i> Setting Options
                        </a>
                        <a href="#" class="profile-dropdown-item">
                            <i class="fas fa-user-circle"></i> My Account
                        </a>
                        <a href="/logout/" class="profile-dropdown-item">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>

                <!-- Cart icon container, moved back to original position -->
                <div class="cart-icon-container" id="cartIconContainer">
                    <i class="fa-solid fa-list"></i> <!-- Reverted to fa-list icon -->
                    <!-- Cart item count display for header -->
                    <span class="cart-item-count" id="header-cart-item-count-display">0</span>
                    <!-- Removed the old cart dropdown from here -->
                </div>

                <!-- Question mark icon, remains at the rightmost corner -->
                <i class="fas fa-question-circle profile-help-icon" id="helpIcon"></i>
            </div>
        </div>

        <!-- Main header content below the top bar -->
        <div class="header">
          <div class="breadcrumb">
            <span class="breadcrumb-link" onclick="history.back()">Back</span>
            <a href="/assessment-summary/" class="breadcrumb-heading">SUMMARY</a>
            <!-- Changed to Font Awesome fa-greater-than icon for precise control -->
            <i class="fa-solid fa-greater-than breadcrumb-separator"></i>
            <a href="/question-library/" class="breadcrumb-heading active">QUESTION</a>
            <i class="fa-solid fa-greater-than breadcrumb-separator"></i>
            <a href="/configuration/" class="breadcrumb-heading">CONFIGURE</a>
            <i class="fa-solid fa-greater-than breadcrumb-separator"></i>
            <a href="/invite-options/" class="breadcrumb-heading">INVITE OPTIONS</a>
          </div>

          <div class="status">
            <span><span class="active-dot"></span> Active</span>
            <!-- Changed icon to fa-solid fa-users -->
            <a href="your_candidate_page.html" style="cursor:pointer; text-decoration: none; color: inherit;"><i class="fa-solid fa-users"></i> CANDIDATE</a>
            <!-- Changed to an <a> tag styled as a button to link to a new page -->
            <a href="invite_page.html" class="invite-btn">+   INVITE</a>
          </div>
        </div>
    </div>

    <aside class="left-sidebar">
        <div class="behavior-check-container">
            <span class="behavior-check" id="behavior-check-toggle">
                <i class="fa-solid fa-bars"></i> <span class="behavior-check-text" id="assessment-name-display">Assessment Name</span>
            </span>
        </div>
        <div class="sidebar-collapsible-content">
            <div class="search-box">
                <input type="text" id="filter-search" placeholder="Search by title & keyword" aria-label="Search filters" />
            </div>

            <div class="filter-and-sort">
                <span>FILTER & SORT</span>
                <button class="clear-all-filters-btn">Clear</button>
            </div>

            <div class="filter-section" id="sort-by-filter-section">
                <h3 data-target="sort-by-options">
                    <span class="filter-title-text">Sort By</span>
                    <button class="toggle-btn" aria-expanded="false" aria-controls="sort-by-options">+</button>
                </h3>
                <ul class="options" id="sort-by-options">
                    <li><label><input type="radio" class="filter-checkbox" name="sort-by" value="popularity" checked /> Popularity</label></li>
                    <li><label><input type="radio" class="filter-checkbox" name="sort-by" value="name" /> Name</label></li>
                    <li><label><input type="radio" class="filter-checkbox" name="sort-by" value="recency" /> Recency</label></li>
                </ul>
            </div>

            <div class="filter-section" id="domain-filter-section">
                <h3 data-target="domain-options">
                    <span class="filter-title-text"> Domain</span>
                    <button class="toggle-btn" aria-expanded="false" aria-controls="domain-options">+</button>
                </h3>
                <ul class="options" id="domain-options">
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="domain" value="Tech" /> Tech</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="domain" value="Non-Tech" /> Non-Tech</label></li>
                </ul>
            </div>

            <div class="filter-section" id="assessment-filter-section">
                <h3 data-target="assessment-options">
                    <span class="filter-title-text"> Question Type</span>
                    <button class="toggle-btn" aria-expanded="false" aria-controls="assessment-options">+</button>
                </h3>
                <ul class="options" id="assessment-options">
                    <li>
                        <label><input type="checkbox" class="filter-checkbox" data-filter-group="assessment" value="Multiple Choice" /> Multiple Choice</label>
                        <ul>
                            <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="assessment" value="Multiple Variants" /> Multiple Variants</label></li>
                        </ul>
                    </li>
                    <li>
                        <label><input type="checkbox" class="filter-checkbox" data-filter-group="assessment" value="Multiple Selection" /> Multiple Selection</label>
                        <ul>
                            <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="assessment" value="Secure Multiple Selection" /> Secure Multiple Selection</label></li>
                            <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="assessment" value="Multiple Variants" /> Multiple Variants</label></li>
                        </ul>
                    </li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="assessment" value="Coding" /> Coding</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="assessment" value="Video" /> Video</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="assessment" value="Typing" /> Typing</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="assessment" value="Simulator" /> Simulator</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="assessment" value="Placeholder 1" /> Placeholder 1</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="assessment" value="Placeholder 2" /> Placeholder 2</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="assessment" value="Placeholder 3" /> Placeholder 3</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="assessment" value="Placeholder 4" /> Placeholder 4</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="assessment" value="Placeholder 5" /> Placeholder 5</label></li>
                </ul>
                <button class="view-more-btn" id="view-more-assessment" data-target-list="assessment-options" data-limit="10">View More</button>
            </div>

            <div class="filter-section" id="programming-filter-section">
                <h3 data-target="programming-options">
                     <span class="filter-title-text"> Programming Language</span>
                     <button class="toggle-btn" aria-expanded="false" aria-controls="programming-options">+</button>
                </h3>
                <ul class="options two-column" id="programming-options">
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="programming-language" value="Java"/> Java</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="programming-language" value="Python"/> Python</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="programming-language" value="C++"/> C++</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="programming-language" value="JavaScript"/> JavaScript</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="programming-language" value="Ruby"/> Ruby</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="programming-language" value="PHP"/> PHP</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="programming-language" value="Swift"/> Swift</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="programming-language" value="Kotlin"/> Kotlin</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="programming-language" value="Go"/> Go</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="programming-language" value="C#"/> C#</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="programming-language" value="TypeScript"/> TypeScript</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="programming-language" value="Rust"/> Rust</label></li>
                </ul>
                <button class="view-more-btn" id="view-more-programming" data-target-list="programming-options" data-limit="10">View More</button>
            </div>

            <div class="filter-section" id="human-language-filter-section">
                <h3 data-target="human-language-options">
                     <span class="filter-title-text"> Language</span>
                     <button class="toggle-btn" aria-expanded="false" aria-controls="human-language-options">+</button>
                </h3>
                <ul class="options two-column" id="human-language-options">
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="human-language" value="English"/> English</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="human-language" value="Spanish"/> Spanish</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="human-language" value="French"/> French</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="human-language" value="German"/> German</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="human-language" value="Chinese"/> Chinese</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="human-language" value="Japanese"/> Japanese</label></li>
                 </ul>
                 <button class="view-more-btn" id="view-more-human-language" data-target-list="human-language-options" data-limit="4">View More</button>
            </div>

            <div class="filter-section" id="owned-by-filter-section">
                <h3 data-target="owned-by-options">
                    <span class="filter-title-text"> Owned By</span>
                    <button class="toggle-btn" aria-expanded="false" aria-controls="owned-by-options">+</button>
                </h3>
                <ul class="options" id="owned-by-options">
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="owned-by" value="My Organization" /> My Organization</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="owned-by" value="FDI(Start Up)" /> FDI(Start Up)</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="owned-by" value="FDI(professional)" /> FDI(professional)</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="owned-by" data-filter-value="FDI(Enterprise)"/> FDI(Enterprise)</label></li>
                </ul>
            </div>

            <div class="filter-section" id="tags-filter-section">
                <h3 data-target="tags-options">
                    <span class="filter-title-text"> Tags</span>
                    <button class="toggle-btn" aria-expanded="false" aria-controls="tags-options">+</button>
                </h3>
                <ul class="options" id="tags-options">
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="tags" value="Application development" /> Application development</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="tags" value="Data Science" /> Data Science</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="tags" value="Database" /> Database</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="tags" value="Front End" /> Front End</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="tags" value="Hibernate" />Hibernate</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="tags" value="React.js" /> React.js</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="tags" value="Algorithms" /> Algorithms</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="tags" value="Android" /> Android</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="tags" value="Angular.js" />Angular.js</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="tags" value="API" />API</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="tags" value="General" />General</label></li>
                     <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="tags" value="Oops" />Oops</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="tags" value="Spring" />Spring</label></li>
                </ul>
                 <button class="view-more-btn" id="view-more-tags" data-target-list="tags-options" data-limit="10">View More</button>
            </div>

            <div class="filter-section" id="difficulty-filter-section">
                <h3 data-target="difficulty-options">
                    <span class="filter-title-text"> Difficulty Level</span>
                    <button class="toggle-btn" aria-expanded="false" aria-controls="difficulty-options">+</button>
                </h3>
                <ul class="options" id="difficulty-options">
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="difficulty" value="Basic" /> Basic</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="difficulty" value="Novice" /> Novice</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="difficulty" value="Intermediate" /> Intermediate</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="difficulty" value="Advanced" /> Advanced</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="difficulty" value="Expert" /> Expert</label></li>
                </ul>
            </div>

            <div class="filter-section" id="depth-of-knowledge-filter-section">
                <h3 data-target="depth-of-knowledge-options">
                    <span class="filter-title-text"> Depth of Knowledge</span>
                    <button class="toggle-btn" aria-expanded="false" aria-controls="depth-of-knowledge-options">+</button>
                </h3>
                <ul class="options" id="depth-of-knowledge-options">
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="depth-of-knowledge" value="Recall & Reproduction" /> Recall & Reproduction</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="depth-of-knowledge" value="Strategic Thinking" /> Strategic Thinking</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="depth-of-knowledge" value="Extended Thinking" /> Extended Thinking</label></li>
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="depth-of-knowledge" value="Skills/Concepts" /> Skills/Concepts</label></li>
                </ul>
            </div>

            <div class="filter-section" id="to-be-used-in-filter-section">
                <h3 data-target="to-be-used-in-options">
                    <span class="filter-title-text"> To be used in</span>
                    <button class="toggle-btn" aria-expanded="false" aria-controls="to-be-used-in-options">+</button>
                </h3>
                <ul class="options" id="to-be-used-in-options">
                    <li><label><input type="checkbox" class="filter-checkbox" data-filter-group="to-be-used-in" value="Live Interview" /> Live Interview</label></li>

                </ul>
            </div>
        </div> </aside>

    <main class="right-content">
        <div class="right-content-header">
            <div class="question-count">
                <span id="question-count-display">0 Questions</span>
            </div>
            <div class="sort-by-container">
                <span>Sort By:</span>
                <div class="sort-by-display-value" id="sort-by-value-display">
                    Popularity
                </div>
            </div>
             <button class="skip-button" id="skip-button">Skip</button>
        </div>

        <div class="right-content-body-wrapper" id="right-content-body-wrapper">
            <div class="selected-filters-container" id="selected-filters-display">
                </div>
            <div class="assessment-cards-grid" id="assessment-cards-grid">
                </div>
        </div>

       <center> <div class="skip-selection-container" id="skip-selection-container">
            <div class="skip-option-card" id="question-library-option">
                <i class="fas fa-book"></i>
                <span class="skip-card-text">+ QUESTION LIBRARY</span>
            </div>
            <div class="skip-option-card" id="create-assessment-option">
                <i class="fas fa-plus-circle"></i>
                <span class="skip-card-text">+ CREATE  NEW QUESTIONS</span>
            </div>
        </div>
    </center>
    </main>

    <!-- Cart Modal Overlay (Copied from pythonAdvancedAssessment.html and adapted) -->
    <div class="modal-overlay" id="cartModalOverlay">
        <div class="modal-content cart-modal">
            <div class="modal-header cart-modal-header">
                <h3><span id="modalItemCount">0</span> Questions added to the list</h3>
                <button class="modal-close-btn" id="cartModalCloseBtn">&times;</button>
            </div>
            <div class="modal-body">
                <!-- NEW: ADDED ASSESSMENT NAME INPUT FIELD -->
                <div class="form-group">
                    <label for="assessmentNameInput">Enter assessment name</label>
                    <input type="text" id="assessmentNameInput" placeholder="Type assessment name here...">
                </div>
                <ul class="cart-modal-item-list" id="cartModalItemList">
                    <!-- Selected questions will be rendered here by JavaScript -->
                </ul>
            </div>
            <div class="modal-footer cart-modal-footer">
                <button class="action-button-modal clear-list-btn" id="clearItemListBtn">Clear Question List</button>
                <button class="action-button-modal create-assessment-btn" id="createAssessmentBtnModal">CREATE ASSESSMENT</button>
            </div>
        </div>
    </div>


    <script>
        // --- Local Storage Management ---
        const LOCAL_STORAGE_KEY = "selectedAssessmentQuestions"; // Consistent key across pages
        const LIBRARY_STORAGE_KEY = 'assessmentLibrary'; // Key for the main library
        const POPULARITY_STORAGE_KEY = 'assessmentPopularity'; // Key for popularity scores

        function getAddedItemsFromLocalStorage() {
            try {
                const storedItems = localStorage.getItem(LOCAL_STORAGE_KEY);
                return storedItems ? JSON.parse(storedItems) : [];
            } catch (e) {
                console.error("Error parsing selected questions from local storage:", e);
                return [];
            }
        }

        function saveAddedItemsToLocalStorage(questions) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(questions));
            } catch (e) {
                console.error("Error saving selected questions to local storage:", e);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // --- Header.html specific JavaScript for profile menu ---
            const profileMenuContainer = document.getElementById('profileMenuContainer');
            const profileDropdown = document.getElementById('profileDropdown');
            const helpIcon = document.getElementById('helpIcon'); // Get the new help icon by ID

            // Toggle dropdown visibility on click, but not when the help icon is clicked
            if (profileMenuContainer && profileDropdown && helpIcon) {
                profileMenuContainer.addEventListener('click', function(event) {
                    // Check if the clicked element is the help icon or contains it
                    if (event.target === helpIcon || helpIcon.contains(event.target)) {
                        event.stopPropagation(); // Prevent click from propagating to the container
                        // Add any specific action for the help icon here if needed
                    } else {
                        event.stopPropagation(); // Prevent click from propagating to document
                        profileDropdown.classList.toggle('show');
                        // Close cart dropdown/modal if open
                        const cartModalOverlay = document.getElementById('cartModalOverlay');
                        if (cartModalOverlay && cartModalOverlay.style.display === 'flex') {
                            cartModalOverlay.style.display = 'none';
                        }
                    }
                });

                // Hide dropdown when clicking outside
                document.addEventListener('click', function(event) {
                    if (!profileMenuContainer.contains(event.target)) {
                        profileDropdown.classList.remove('show');
                    }
                });
            }
            // --- End Header.html specific JavaScript ---


            // --- Data for Assessments ---
            const assessmentData = [
                {
                    id: "javaFullStack",
                    title: "Java Full stack", // Displayed on card
                    description: "Comprehensive assessment covering front-end and back-end Java technologies including Spring Boot, React, and database integration.",
                    cardIconText: "FD",
                    cardIconBgColor: "#305598",
                    author: "face d interview",
                    domain: "Tech",
                    imageUrl: "https://placehold.co/280x120/A52A2A/FFFFFF?text=Java+FS",
                    imageAlt: "Java Full Stack Assessment",
                    techTagsOverlay: ["JavaScript", "Oops", "Spring"],
                    isPremium: false,
                    premiumDescription: "Unlock this advanced Java Full Stack challenge, designed by industry experts to test in-depth knowledge. Requires Professional Plan.",
                    createdDate: "2024-03-15",
                    popularity: 0,
                    viewLink: "/java-advanced-assessment/",
                    customizeLink: "/java-advanced-assessment/",
                    assessmentType: "Coding",
                    difficulty: "Intermediate",
                    depthOfKnowledge: "Strategic Thinking",
                    ownedBy: "My Organization",
                    filterTags: ["JavaScript", "General", "Tech", "Java", "Spring", "Collections","Lambda","Arrays"],
                    humanLanguage: "English",
                    // Added questionTextFull for display in cart modal
                    questionTextFull: "Comprehensive assessment covering front-end and back-end Java technologies including Spring Boot, React, and database integration.",
                    toBeUsedIn: "Live Interview"
                },
                {
                    id: "pythonAdvanced",
                    title: "Python Advanced Concepts", // Displayed on card
                    description: "Dive deep into advanced Python topics like decorators, metaclasses, concurrency, and advanced data structures.",
                    cardIconText: "PY",
                    cardIconBgColor: "#306998", // Python blue
                    author: "FDI Platform",
                    domain: "Tech",
                    imageUrl: "https://placehold.co/280x120/306998/FFFFFF?text=Python+Adv",
                    imageAlt: "Python Advanced Assessment",
                    techTagsOverlay: ["Data Science", "Algorithms"], // Kept from original static card
                    isPremium: false,
                    premiumDescription: "Access exclusive Python questions covering core Data Science concepts. Ideal for professional-level screening.",
                    createdDate: "2024-02-20",
                    popularity: 0,
                    viewLink: "/python-advanced-assessment/",
                    customizeLink: "/python-advanced-assessment/",
                    assessmentType: "Multiple Choice",
                    difficulty: "Basic",
                    depthOfKnowledge: "Recall & Reproduction",
                    ownedBy: "FDI(Start Up)",
                    filterTags: ["Python", "Data Science", "Algorithms", "Tech"],
                    humanLanguage: "Spanish",
                    // Added questionTextFull for display in cart modal
                    questionTextFull: "Dive deep into advanced Python topics like decorators, metaclasses, concurrency, and advanced data structures.",
                    toBeUsedIn: "Live Interview",
                },
                {
                 id: "DeVops Assessment",
                    title: "DevOps",
                    description: "A comprehensive assessment covering fundamental DevOps concepts, including CI/CD pipelines, containerization, and cloud infrastructure.",
                    cardIconText: "DV",
                    cardIconBgColor: "#306998",
                    author: "face d interview",
                    domain: "Tech",
                    imageUrl: "https://placehold.co/280x120/306998/FFFFFF?text=DevOps",
                    imageAlt: "DevOps Coding Challenge",
                    techTagsOverlay: ["CI/CD", "Cloud", "Containers"],
                    isPremium: false,
                    createdDate: "2025-06-24",
                    popularity: 0,
                    viewLink: "/devops-assessment/",
                    customizeLink: "/devops-assessment/",
                    assessmentType: "Coding",
                    difficulty: "Basic",
                    depthOfKnowledge: "Strategic Thinking",
                    ownedBy: "My Organization",
                    filterTags: ["DevOps", "CI/CD", "Cloud","Kubernetes", "Containers", "Tech", "Coding"],
                    humanLanguage: "English",
                    questionTextFull: "A comprehensive assessment covering fundamental DevOps concepts, including CI/CD pipelines, containerization, and cloud infrastructure.",
                    toBeUsedIn: "Live Interview "
                },
                {
                    id: "javascriptFundamentals",
                    title: "JavaScript Fundamentals", // Displayed on card
                    description: "Test foundational knowledge of JavaScript, including DOM manipulation, ES6 features, and basic programming concepts.",
                    cardIconText: "FD",
                    cardIconBgColor: "#f0db4f", // JS yellow
                    cardIconColor: "#323330", // Dark text for JS icon
                    author: " face d interview",
                    domain: "Tech",
                    imageUrl: "https://placehold.co/280x120/f0db4f/323330?text=JS+Basics",
                    imageAlt: "JavaScript Fundamentals Assessment",
                    techTagsOverlay: ["Vanilla JS", "DOM", "ES6"], // Kept from original static card
                    isPremium: false,
                    premiumDescription: null,
                    createdDate: "2023-12-01",
                    popularity: 0,
                    viewLink: "/javascript-fundamentals/",
                    customizeLink: "/javascript-fundamentals/",
                    assessmentType: "Coding",
                    difficulty: "Intermediate",
                    depthOfKnowledge: "Strategic Thinking",
                    ownedBy: "FDI(Start Up)",
                    filterTags: ["JavaScript", "Frontend", "WebDev", "Tech", "Algorithms", "Vanilla JS", "DOM", "ES6"],
                    humanLanguage: "English",
                    // Added questionTextFull for display in cart modal
                    questionTextFull: "Test foundational knowledge of JavaScript, including DOM manipulation, ES6 features, and basic programming concepts.",
                    toBeUsedIn: "Live Interview"
                },
                // Additional cards from dummy.html data
                {
                     id: "CyberSecurity", // Different ID
                    title: "Cyber Security",
                    description: "Cybersecurity is the practice of protecting systems, networks, and data from digital attacks.",
                    cardIconText: "CS",
                    cardIconBgColor: "#2E8B57", // Seagreen
                    author: "face d interview",
                    domain: "Tech",
                    imageUrl: "https://placehold.co/280x120/2E8B57/FFFFFF?text=CyberSecurity",
                    imageAlt: "Advanced Coding Question 4",
                    techTagsOverlay: ["confidentiality", "integrity", "availability"],
                    isPremium: false,
                    createdDate: "2025-06-24",
                    popularity: 0,
                    viewLink: "/cybersecurity-assessment/",
                    customizeLink: "/cybersecurity-assessment/",
                    assessmentType: "Coding",
                    difficulty: "Advanced",
                    depthOfKnowledge: "Extended Thinking",
                    ownedBy: "FDI(Enterprise)",
                    filterTags: ["Python", "General", "Tech", "Algorithms", "Coding"],
                    humanLanguage: "English",
                    // Added questionTextFull for display in cart modal
                    questionTextFull: "An advanced coding challenge focusing on complex algorithms and data structures, requiring optimized solutions.",
                    toBeUsedIn: "Live Interview "
                },
                {
                     id: "CyberSecurity Advanced Questions", // Different ID
                    title: "Cyber Security Advanced Questions",
                    description: " Advanced cybersecurity involves securing digital infrastructure through proactive threat detection, real-time monitoring, and adaptive defense strategies.It aims to mitigate sophisticated threats like APTs, zero-day attacks, and insider breaches across critical systems and networks.",
                    cardIconText: "CS",
                    cardIconBgColor: "#2E8B57", // Seagreen
                    author: "face d interview",
                    domain: "Tech",
                    imageUrl: "https://placehold.co/280x120/2E8B57/FFFFFF?text=CyberSecurity",
                    imageAlt: "Advanced Coding Question 4",
                    techTagsOverlay: ["Network Security", "Cryptography", "availabiThreat Intelligence"],
                    isPremium: false,
                    createdDate: "2025-06-24",
                    popularity: 0,
                    viewLink: "/cybersecurity-advanced-assessment/",
                    customizeLink: "/cybersecurity-advanced-assessment/",
                    assessmentType: "Coding",
                    difficulty: "Advanced",
                    depthOfKnowledge: "Extended Thinking",
                    ownedBy: "FDI(Enterprise)",
                    filterTags: ["Devops", "General", "Tech", "Algorithms", "Coding"],
                    humanLanguage: "English",
                    // Added questionTextFull for display in cart modal
                    questionTextFull: "Advanced cybersecurity involves securing digital infrastructure through proactive threat detection, real-time monitoring, and adaptive defense strategies.It aims to mitigate sophisticated threats like APTs, zero-day attacks, and insider breaches across critical systems and networks.",
                    toBeUsedIn: "Live Interview "
                },
                {
                 id: "DevOps Advanced Assessment ",
                    title: "DevOps Advanced Assessment",
                    description: "A comprehensive assessment covering fundamental DevOps concepts, including CI/CD pipelines, containerization, and cloud infrastructure.",
                    cardIconText: "DV",
                    cardIconBgColor: "#306998",
                    author: "face d interview",
                    domain: "Tech",
                    imageUrl: "https://placehold.co/280x120/306998/FFFFFF?text=DevOps Advanced",
                    imageAlt: "DevOps Coding Challenge",
                    techTagsOverlay: [" Kubernetes", "Infrastructure", "CI/CD"],
                    isPremium: false,
                    createdDate: "2025-06-24",
                    popularity: 0,
                    viewLink: "/advanced-devops-assessment/",
                    customizeLink: "/advanced-devops-assessment/",
                    assessmentType: "Coding",
                    difficulty: "Basic",
                    depthOfKnowledge: "Strategic Thinking",
                    ownedBy: "My Organization",
                    filterTags: ["DevOps", "CI/CD", "Infrastructure", "Containers", "Tech", "Coding"],
                    humanLanguage: "English",
                    questionTextFull: "A comprehensive assessment covering fundamental DevOps concepts, including CI/CD pipelines, containerization, and cloud infrastructure.",
                    toBeUsedIn: "Live Interview "
                },
                 
                {
                    id: "Python Fundamentals  Assessment",
                    title: "Python Fundamentals Assessment ",
                    description: "A coding challenge focusing on fundamental Python programming, including basic syntax, control flow, and functions.",
                    cardIconText: "PC",
                    cardIconBgColor: "#306998", // Python blue
                    author: "face d interview",
                    domain: "Tech",
                    imageUrl: "https://placehold.co/280x120/306998/FFFFFF?text=Python",
                    imageAlt: "Python OOP Coding Challenge",
                    techTagsOverlay: ["Python", "OOP", "Data Structures"],
                    isPremium: false,
                    createdDate: "2023-11-20",
                    popularity: 0,
                    viewLink: "/python-fundamentals-assessment/",
                    customizeLink: "/python-fundamentals-assessment/",
                    assessmentType: "Coding",
                    difficulty: "Basic",
                    depthOfKnowledge: "Strategic Thinking",
                    ownedBy: "My Organization",
                    filterTags: ["Python", "OOP", "Data Structures", "General", "Tech", "Coding"],
                    humanLanguage: "English",
                    // Added questionTextFull for display in cart modal
                    questionTextFull: "A coding challenge focusing on fundamental Python programming, including basic syntax, control flow, and functions.",
                    toBeUsedIn: "Live Interview "
                },
                {
                    id: "manualTesting",
                    title: "Manual Testing", // Displayed on card
                    description: "Thorough assessment focused on manual testing concepts, techniques, test case design, and defect lifecycle understanding.",
                    cardIconText: "MT",
                    cardIconBgColor: "#6C3483",
                    author: "face d interview",
                    domain: "Tech",
                    imageUrl: "https://placehold.co/280x120/6C3483/FFFFFF?text=Manual+Testing",
                    imageAlt: "Manual Testing Assessment",
                    techTagsOverlay: ["Test Cases", "Bug Tracking", "SDLC"],
                    isPremium: false,
                    premiumDescription: "Unlock this Manual Testing challenge designed to evaluate hands-on QA skills. Available with Professional Plan.",
                    createdDate: "2024-03-15",
                    popularity: 0,
                    viewLink: "/manual-testing-assessment/",
                    customizeLink: "/manual-testing-assessment/",
                    assessmentType: "MCQ",
                    difficulty: "Beginner",
                    depthOfKnowledge: "Basic Understanding",
                    ownedBy: "My Organization",
                    filterTags: ["Testing", "QA", "Manual", "SDLC", "Bug Tracking", "Test Cases"],
                    humanLanguage: "English",
                    // Added questionTextFull for display in cart modal
                    questionTextFull: "Thorough assessment focused on manual testing concepts, techniques, test case design, and defect lifecycle understanding.",
                    toBeUsedIn: "Live Interview"
                },
                {
                    id: "advancedManualTesting",
                    title: "Advanced Manual Testing", // Displayed on card
                    description: "In-depth assessment evaluating advanced manual testing strategies, exploratory testing, edge case handling, and real-world defect analysis.",
                    cardIconText: "AT",
                    cardIconBgColor: "#884EA0",
                    author: "face d interview",
                    domain: "Tech",
                    imageUrl: "https://placehold.co/280x120/884EA0/FFFFFF?text=Advanced+Manual+Testing",
                    imageAlt: "Advanced Manual Testing Assessment",
                    techTagsOverlay: ["Exploratory", "Edge Cases", "Bug Life Cycle"],
                    isPremium: false,
                    premiumDescription: "Unlock this advanced manual testing challenge designed for experienced QA professionals. Requires Professional Plan.",
                    createdDate: "2024-03-15",
                    popularity: 0,
                    viewLink: "/advanced-manual-testing-assessment/",
                    customizeLink: "/advanced-manual-testing-assessment/",
                    assessmentType: "Scenario-based MCQ",
                    difficulty: "Advanced",
                    depthOfKnowledge: "Expert Judgment",
                    ownedBy: "My Organization",
                    filterTags: ["Testing", "QA", "Manual", "Advanced", "Edge Cases", "Bug Life Cycle", "Exploratory"],
                    humanLanguage: "English",
                    // Added questionTextFull for display in cart modal
                    questionTextFull: "In-depth assessment evaluating advanced manual testing strategies, exploratory testing, edge case handling, and real-world defect analysis.",
                    toBeUsedIn: "Live Interview"
                }


                
            ];


            // --- DOM Elements ---
            const filterSections = document.querySelectorAll('.filter-section');
            const searchInput = document.getElementById('filter-search');
            const body = document.body;
            const behaviorCheckToggle = document.getElementById('behavior-check-toggle');
            const sidebarCollapsibleContent = document.querySelector('.sidebar-collapsible-content');
            const clearAllButton = document.querySelector('.clear-all-filters-btn');
            const sortByDisplayValue = document.getElementById('sort-by-value-display');
            const selectedFiltersContainer = document.getElementById('selected-filters-display');
            const assessmentNameDisplay = document.getElementById('assessment-name-display');
            const questionCountDisplay = document.getElementById('question-count-display');
            const assessmentCardsGrid = document.getElementById('assessment-cards-grid');
            const skipButton = document.getElementById('skip-button');
            const skipSelectionContainer = document.getElementById('skip-selection-container');
            const questionLibraryOption = document.getElementById('question-library-option');
            const createAssessmentOption = document.getElementById('create-assessment-option');
            const headerCartItemCountDisplay = document.getElementById('header-cart-item-count-display'); // Cart count in header
            const cartIconContainer = document.getElementById('cartIconContainer'); // Cart icon container in header

            // New: Cart modal elements
            const cartModalOverlay = document.getElementById('cartModalOverlay');
            const cartModalCloseBtn = document.getElementById('cartModalCloseBtn');
            const cartModalItemList = document.getElementById('cartModalItemList');
            const modalItemCount = document.getElementById('modalItemCount');
            const clearItemListBtn = document.getElementById('clearItemListBtn');
            const createAssessmentBtnModal = document.getElementById('createAssessmentBtnModal');
            // NEW: Get assessment name input from modal
            const assessmentNameInput = document.getElementById('assessmentNameInput');


            const selectedFilterMap = new Map(); // To keep track of selected filter tags and their elements

            // --- State Variable for selected questions (from Local Storage) ---
            let selectedAssessmentsInCart = getAddedItemsFromLocalStorage();

            // --- Helper Functions ---
            function showCustomAlert(message, type = 'info') {
                const existingModal = document.getElementById('custom-alert-modal');
                if (existingModal) document.body.removeChild(existingModal);
                const modal = document.createElement('div');
                modal.id = 'custom-alert-modal';
                let bgColor = type === 'success' ? 'var(--success-color)' : (type === 'error' ? 'var(--danger-color)' : 'white');
                let textColor = type === 'info' ? 'var(--text-color-dark)' : 'var(--text-color-light)';
                modal.style.cssText = `
                    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                    background-color: ${bgColor}; color: ${textColor}; padding: 15px 25px;
                    border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1005;
                    display: flex; flex-direction: column; align-items: center; gap: 15px;
                    font-family: var(--font-family-sans); text-align: center; max-width: 90%;
                    border: 1px solid ${type === 'info' ? 'var(--border-color-light)' : 'transparent'};
                    animation: cardFadeInUp 0.4s ease;
                `;
                modal.innerHTML = `<p style="font-size: 16px; margin:0;">${message}</p><button style="background-color: ${type === 'info' ? 'var(--primary-color)' : 'rgba(0,0,0,0.2)'}; color: var(--text-color-light); border: none; padding: 8px 18px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: background-color 0.2s ease;">OK</button>`;
                document.body.appendChild(modal);
                const okButton = modal.querySelector('button');
                okButton.onmouseover = () => okButton.style.backgroundColor = type === 'info' ? 'var(--primary-color-light)' : 'rgba(0,0,0,0.3)';
                okButton.onmouseout = () => okButton.style.backgroundColor = type === 'info' ? 'var(--primary-color)' : 'rgba(0,0,0,0.2)';
                okButton.addEventListener('click', () => document.body.removeChild(modal));
                setTimeout(() => { if (document.body.contains(modal)) document.body.removeChild(modal); }, 5000);
            }

            function calculateMaxHeight(optionsList) {
                let maxHeight = 0;
                const listItems = optionsList.querySelectorAll('li');
                const tempRevealedForHeight = [];

                // Temporarily unhide items to calculate full scrollHeight
                listItems.forEach(li => {
                    if (li.classList.contains('hidden-item')) {
                        tempRevealedForHeight.push(li);
                        li.classList.remove('hidden-item');
                    }
                });
                maxHeight = optionsList.scrollHeight;
                // Restore hidden items
                tempRevealedForHeight.forEach(li => li.classList.add('hidden-item'));
                return maxHeight + "px";
            }

            function updateQuestionCount() {
                // Count cards that are not styled with 'display: none'
                const visibleCards = Array.from(assessmentCardsGrid.children).filter(card => card.style.display !== 'none');
                const count = visibleCards.length;
                if (questionCountDisplay) {
                    questionCountDisplay.textContent = `${count} Question${count !== 1 ? 's' : ''}`;
                }
            }

            // Function to update the cart count in the header and modal
            function updateCartCountHeader() {
                if (headerCartItemCountDisplay) {
                    const count = selectedAssessmentsInCart.length;
                    if (count > 0) {
                        headerCartItemCountDisplay.textContent = '*';
                        headerCartItemCountDisplay.style.display = 'flex'; // Show the indicator
                    } else {
                        headerCartItemCountDisplay.style.display = 'none'; // Hide the indicator
                    }
                }
                if (modalItemCount) {
                    modalItemCount.textContent = selectedAssessmentsInCart.length;
                }
                if (createAssessmentBtnModal) {
                    createAssessmentBtnModal.disabled = selectedAssessmentsInCart.length === 0;
                    createAssessmentBtnModal.classList.toggle('disabled', selectedAssessmentsInCart.length === 0);
                }
            }
            
            // --- Function to show clear list confirmation ---
            function showClearListConfirmation() {
                const existingModal = document.querySelector('.confirm-clear-modal-overlay');
                if(existingModal) {
                    document.body.removeChild(existingModal);
                }

                const numItems = selectedAssessmentsInCart.length;
                const message = numItems > 1
                    ? `Are you sure you want to delete all ${numItems} questions from the list?`
                    : "Are you sure you want to delete this question from the list?";

                const overlay = document.createElement('div');
                overlay.className = 'confirm-clear-modal-overlay';
                overlay.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background-color: rgba(0, 0, 0, 0.6); z-index: 1002;
                    display: flex; align-items: center; justify-content: center;
                `;

                const content = document.createElement('div');
                content.className = 'confirm-clear-modal-content';
                content.style.cssText = `
                    background-color: #ffffff; border-radius: 6px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%;
                    max-width: 450px; display: flex; flex-direction: column;
                    position: relative;
                `;

                const header = document.createElement('div');
                header.style.cssText = `
                    display: flex; justify-content: space-between; align-items: center;
                    padding: 10px 15px; border-bottom: 1px solid #eee;
                `;
                
                const headerTitle = document.createElement('h3');
                headerTitle.textContent = 'Confirm Clear List';
                headerTitle.style.fontSize = '16px';
                headerTitle.style.fontWeight = '600';
                
                const closeButton = document.createElement('button');
                closeButton.innerHTML = '&times;';
                closeButton.style.cssText = `
                    background: none; border: none; font-size: 24px;
                    cursor: pointer; color: #999;
                `;
                closeButton.onclick = () => document.body.removeChild(overlay);
                
                header.appendChild(headerTitle);
                header.appendChild(closeButton);

                const bodyDiv = document.createElement('div');
                bodyDiv.className = 'modal-body';
                bodyDiv.style.padding = '15px';
                bodyDiv.innerHTML = `<p style="font-size: 14px; color: var(--text-color-dark);">${message}</p>`;

                const footer = document.createElement('div');
                footer.className = 'modal-footer';
                footer.style.justifyContent = 'flex-end';
                footer.style.padding = '10px 15px';
                footer.style.backgroundColor = '#f7f7f7';

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.style.cssText = `
                    background-color: #ffffff; color: #333; border: 1px solid #ccc;
                    padding: 6px 12px; font-size: 12px; border-radius: 4px; cursor: pointer;
                    margin-right: 10px;
                    transition: background-color 0.2s;
                `;
                 cancelButton.onmouseover = () => cancelButton.style.backgroundColor = '#f0f0f0';
                 cancelButton.onmouseout = () => cancelButton.style.backgroundColor = '#ffffff';
                cancelButton.onclick = () => document.body.removeChild(overlay);

                const deleteAllButton = document.createElement('button');
                deleteAllButton.textContent = 'Yes, Clear All';
                deleteAllButton.style.cssText = `
                    background-color: #ffffff; color: var(--danger-color); border: 1px solid var(--danger-color);
                    padding: 6px 12px; font-size: 12px; border-radius: 4px; cursor: pointer;
                    transition: background-color 0.2s, color 0.2s;
                `;
                deleteAllButton.onmouseover = () => {
                    deleteAllButton.style.backgroundColor = 'var(--danger-color)';
                    deleteAllButton.style.color = 'white';
                };
                 deleteAllButton.onmouseout = () => {
                    deleteAllButton.style.backgroundColor = '#ffffff';
                    deleteAllButton.style.color = 'var(--danger-color)';
                };
                deleteAllButton.onclick = () => {
                    selectedAssessmentsInCart = [];
                    saveAddedItemsToLocalStorage([]);
                    updateCartCountHeader();
                    renderSelectedQuestionsList();
                    document.body.removeChild(overlay);
                    showCustomAlert('Question list has been cleared.', 'success');
                };

                footer.appendChild(cancelButton);
                footer.appendChild(deleteAllButton);
                
                content.appendChild(header);
                content.appendChild(bodyDiv);
                content.appendChild(footer);
                overlay.appendChild(content);

                document.body.appendChild(overlay);
            }

            // --- Function to show deletion confirmation ---
            function showDeleteConfirmation(itemId) {
                const existingModal = document.querySelector('.confirm-delete-modal-overlay');
                if(existingModal) {
                    document.body.removeChild(existingModal);
                }

                const itemToRemove = selectedAssessmentsInCart.find(item => (item.id === itemId) || (item.questionId === itemId));
                if (!itemToRemove) {
                    console.error("Item to delete not found in cart:", itemId);
                    return;
                }
                const titleForAlert = itemToRemove.title || itemToRemove.questionTextFull || "this question";

                const overlay = document.createElement('div');
                overlay.className = 'confirm-delete-modal-overlay';
                overlay.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background-color: rgba(0, 0, 0, 0.6); z-index: 1002;
                    display: flex; align-items: center; justify-content: center;
                `;

                const content = document.createElement('div');
                content.className = 'confirm-delete-modal-content';
                content.style.cssText = `
                    background-color: #ffffff; border-radius: 6px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%;
                    max-width: 450px; display: flex; flex-direction: column;
                    position: relative;
                `;

                const header = document.createElement('div');
                header.style.cssText = `
                    display: flex; justify-content: space-between; align-items: center;
                    padding: 10px 15px; border-bottom: 1px solid #eee;
                `;
                
                const headerTitle = document.createElement('h3');
                headerTitle.textContent = 'Confirm Deletion';
                headerTitle.style.fontSize = '16px';
                headerTitle.style.fontWeight = '600';
                
                const closeButton = document.createElement('button');
                closeButton.innerHTML = '&times;';
                closeButton.style.cssText = `
                    background: none; border: none; font-size: 24px;
                    cursor: pointer; color: #999;
                `;
                closeButton.onclick = () => document.body.removeChild(overlay);
                
                header.appendChild(headerTitle);
                header.appendChild(closeButton);

                const bodyDiv = document.createElement('div');
                bodyDiv.className = 'modal-body';
                bodyDiv.style.padding = '15px';
                bodyDiv.innerHTML = `<p style="font-size: 14px; color: var(--text-color-dark);">Are you sure you want to remove "<strong>${titleForAlert}</strong>" from the list?</p>`;

                const footer = document.createElement('div');
                footer.className = 'modal-footer';
                footer.style.justifyContent = 'flex-end';
                footer.style.padding = '10px 15px';
                footer.style.backgroundColor = '#f7f7f7';

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.style.cssText = `
                    background-color: #ffffff; color: #333; border: 1px solid #ccc;
                    padding: 6px 12px; font-size: 12px; border-radius: 4px; cursor: pointer;
                    transition: background-color 0.2s;
                `;
                 cancelButton.onmouseover = () => cancelButton.style.backgroundColor = '#f0f0f0';
                 cancelButton.onmouseout = () => cancelButton.style.backgroundColor = '#ffffff';
                cancelButton.onclick = () => document.body.removeChild(overlay);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.style.cssText = `
                    background-color: #ffffff; color: var(--danger-color); border: 1px solid var(--danger-color);
                    padding: 6px 12px; font-size: 12px; border-radius: 4px; cursor: pointer;
                    transition: background-color 0.2s, color 0.2s;
                `;
                deleteButton.onmouseover = () => {
                    deleteButton.style.backgroundColor = 'var(--danger-color)';
                    deleteButton.style.color = 'white';
                };
                 deleteButton.onmouseout = () => {
                    deleteButton.style.backgroundColor = '#ffffff';
                    deleteButton.style.color = 'var(--danger-color)';
                };
                deleteButton.onclick = () => {
                    handleAddItemToList(itemId);
                    document.body.removeChild(overlay);
                };

                footer.appendChild(cancelButton);
                footer.appendChild(deleteButton);
                
                content.appendChild(header);
                content.appendChild(bodyDiv);
                content.appendChild(footer);
                overlay.appendChild(content);

                document.body.appendChild(overlay);
            }

            // Function to render selected questions in the cart modal
            function renderSelectedQuestionsList() {
                if (!cartModalItemList) return;
                cartModalItemList.innerHTML = ''; // Clear existing list

                if (selectedAssessmentsInCart.length === 0) {
                    const emptyMessage = document.createElement('li');
                    emptyMessage.classList.add('empty-cart-message');
                    emptyMessage.textContent = 'No questions added yet.';
                    cartModalItemList.appendChild(emptyMessage);
                    return;
                }

                selectedAssessmentsInCart.forEach((item, index) => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('cart-modal-item');
                    const itemId = item.id || item.questionId; // Use either id or questionId
                    listItem.dataset.id = itemId; // Store ID for removal

                    const titleSpan = document.createElement('span');
                    titleSpan.classList.add('cart-modal-item-text');
                    const displayTitle = item.questionTextFull || item.description || item.title;
                    titleSpan.innerHTML = `<span class="item-q-number">Q${index + 1}:</span> ${displayTitle}`;
                    listItem.appendChild(titleSpan);

                    const removeIcon = document.createElement('button');
                    removeIcon.classList.add('cart-modal-item-remove-btn');
                    removeIcon.dataset.questionId = itemId; // Use questionId for removal
                    removeIcon.innerHTML = `<i class="fas fa-trash-alt"></i>`;
                    removeIcon.title = `Remove ${item.title}`;
                    removeIcon.addEventListener('click', (event) => {
                        event.stopPropagation();
                        showDeleteConfirmation(itemId); // Call confirmation instead of direct deletion
                    });
                    listItem.appendChild(removeIcon);

                    cartModalItemList.appendChild(listItem);
                });
            }

            function handleAddItemToList(assessmentId) {
                const index = selectedAssessmentsInCart.findIndex(item => (item.id === assessmentId) || (item.questionId === assessmentId));

                if (index > -1) {
                    const itemToRemove = selectedAssessmentsInCart[index];
                    const titleForAlert = itemToRemove.title || itemToRemove.questionTextFull || "Item";
                    selectedAssessmentsInCart.splice(index, 1);
                } else {
                    const assessmentToAdd = assessmentData.find(a => a.id === assessmentId);
                    if (assessmentToAdd) {
                        selectedAssessmentsInCart.push(assessmentToAdd);
                        showCustomAlert(`${assessmentToAdd.title} added to list!`, 'success');
                    } else {
                        console.error("Attempted to add an item that could not be found in assessmentData:", assessmentId);
                        return;
                    }
                }

                saveAddedItemsToLocalStorage(selectedAssessmentsInCart);
                updateCartCountHeader();
                renderSelectedQuestionsList();
            }


            // --- Function to Render a Single Assessment Card ---
            function renderAssessmentCard(assessment) {
                const card = document.createElement('div');
                card.classList.add('assessment-card');
                if (assessment.isPremium) {
                    card.classList.add('premium-card');
                }

                card.dataset.id = assessment.id;
                card.dataset.title = assessment.title;
                card.dataset.createdDate = assessment.createdDate;
                card.dataset.popularity = assessment.popularity;
                card.dataset.techTags = assessment.techTagsOverlay ? assessment.techTagsOverlay.join(',') : '';
                card.dataset.domain = assessment.domain;
                card.dataset.assessmentType = assessment.assessmentType;
                card.dataset.difficulty = assessment.difficulty;
                card.dataset.depthOfKnowledge = assessment.depthOfKnowledge;
                card.dataset.ownedBy = assessment.ownedBy;
                card.dataset.tags = assessment.filterTags ? assessment.filterTags.join(',') : '';
                card.dataset.humanLanguage = assessment.humanLanguage;
                card.dataset.toBeUsedIn = assessment.toBeUsedIn;
                card.dataset.questionTextFull = assessment.questionTextFull || assessment.description || assessment.title;


                const domainTagColor = assessment.domain.toLowerCase() === 'tech' ? '#28a740' : '#ff9800';

                let techTagsOverlayHTML = '';
                if (!assessment.isPremium && assessment.techTagsOverlay && assessment.techTagsOverlay.length > 0) {
                    techTagsOverlayHTML = assessment.techTagsOverlay.map(tag => `<span>${tag}</span>`).join('');
                }

                const cardIconFinalBgColor = assessment.cardIconBgColor || (assessment.domain.toLowerCase() === 'tech' ? '#28a745' : '#ff9800');
                const cardIconFinalColor = assessment.cardIconColor || 'var(--text-color-light)';

                let buttonHTML = '';
                if (assessment.isPremium) {
                    buttonHTML = `<button class="action-button upgrade-button">UPGRADE PLAN</button>`;
                } else if (assessment.customizeLink) {
                    buttonHTML = `<button class="action-button customize-card-btn" data-assessment-id="${assessment.id}">+ CUSTOMIZE</button>`;
                }


                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-icon" style="background-color: ${cardIconFinalBgColor}; color: ${cardIconFinalColor};">${assessment.cardIconText || 'FD'}</div>
                        <div class="card-title">${assessment.title}</div>
                        <a href="${assessment.viewLink || '#'}" class="card-external-link" title="View ${assessment.title} Details"><i class="fas fa-external-link-alt"></i></a>
                    </div>
                    <div class="card-meta">
                        by ${assessment.author || 'FDI Platform'} <span class="tech-tag" style="background-color: ${domainTagColor};">${assessment.domain}</span>
                    </div>
                    <div class="card-description">${assessment.description || 'No description available.'}</div>
                    <div class="created-on-date">Created on ${new Date(assessment.createdDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                    <div class="card-image-placeholder">
                        <img src="${assessment.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/280x120/f0f0f0/777?text=Image+Error';" alt="${assessment.imageAlt || assessment.title}">
                        ${assessment.isPremium ? `
                            <div class="premium-image-overlay">
                                <i class="fas fa-lock lock-icon"></i>
                                <span class="premium-text">PREMIUM</span>
                            </div>
                        ` : `
                            <div class="card-tech-tags-overlay">
                                ${techTagsOverlayHTML}
                            </div>
                        `}
                    </div>
                    ${assessment.isPremium && assessment.premiumDescription ? `<div class="card-meta premium-description">${assessment.premiumDescription}</div>` : ''}
                    <div class="card-footer">
                        ${buttonHTML}
                    </div>
                `;
                return card;
            }

            // --- Function to Populate Assessment Cards Grid ---
            function populateAssessmentCards() {
                if (!assessmentCardsGrid) return;

                // --- NEW: Popularity Management Logic ---
                let popularityData = JSON.parse(localStorage.getItem(POPULARITY_STORAGE_KEY));

                // If no popularity data in storage, initialize it from the static data.
                // This runs only on the first visit or after clearing storage.
                if (!popularityData) {
                    popularityData = {};
                    assessmentData.forEach(assessment => {
                        // The popularity is already set to 0 in the assessmentData array.
                        popularityData[assessment.id] = assessment.popularity;
                    });
                    localStorage.setItem(POPULARITY_STORAGE_KEY, JSON.stringify(popularityData));
                }

                // Update the main assessmentData array with the latest popularity counts from localStorage.
                assessmentData.forEach(assessment => {
                    if (popularityData.hasOwnProperty(assessment.id)) {
                        assessment.popularity = popularityData[assessment.id];
                    } else {
                        // If a new assessment is added to the code but not in storage, add it with its default popularity (which is now 0).
                        popularityData[assessment.id] = assessment.popularity;
                    }
                });
                 // Save back to storage in case new assessments were added to the hardcoded list.
                localStorage.setItem(POPULARITY_STORAGE_KEY, JSON.stringify(popularityData));
                // --- END: Popularity Management Logic ---


                assessmentCardsGrid.innerHTML = ''; // Clear existing static cards
                selectedAssessmentsInCart = getAddedItemsFromLocalStorage();
                assessmentData.forEach((assessment, index) => {
                    const cardElement = renderAssessmentCard(assessment);
                    // Add staggered animation delay
                    cardElement.style.animationDelay = `${index * 70}ms`;
                    assessmentCardsGrid.appendChild(cardElement);
                });
                applySortAndFilter();
                updateCartCountHeader();
                renderSelectedQuestionsList();
            }


            // --- View More Button Functionality ---
            const viewMoreButtons = document.querySelectorAll('.view-more-btn');
            viewMoreButtons.forEach(button => {
                const targetListId = button.dataset.targetList;
                const limit = parseInt(button.dataset.limit, 10);
                const listElement = document.getElementById(targetListId);
                const parentSection = button.closest('.filter-section');

                if (listElement) {
                    const listItems = Array.from(listElement.querySelectorAll('li'));

                    for (let i = limit; i < listItems.length; i++) {
                        listItems[i].classList.add('hidden-item');
                    }
                    if (listItems.length > limit) {
                        button.style.display = 'block';
                    } else {
                        button.style.display = 'none';
                    }


                    button.addEventListener('click', function() {
                        const isShowingMore = this.textContent.trim().toLowerCase() === 'view less';

                        listItems.forEach((item, index) => {
                            if (isShowingMore) {
                                if (index >= limit) item.classList.add('hidden-item');
                            } else {
                                item.classList.remove('hidden-item');
                            }
                        });

                        this.textContent = isShowingMore ? 'View More' : 'View Less';

                        if (parentSection && parentSection.classList.contains('active')) {
                             setTimeout(() => {
                                const optionsList = parentSection.querySelector('.options');
                                const currentMaxHeight = calculateMaxHeight(optionsList);
                                optionsList.style.maxHeight = currentMaxHeight;
                             }, 0);
                        }
                    });
                }
            });


            // --- Filtering and Sorting ---
            function filterAssessmentCards() {
                if (!assessmentCardsGrid) return;
                const cards = assessmentCardsGrid.querySelectorAll('.assessment-card');
                const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : "";
                const selectedFilters = {};

                document.querySelectorAll('.filter-checkbox:checked').forEach(checkbox => {
                    if (checkbox.type !== 'radio') {
                        const group = checkbox.getAttribute('data-filter-group');
                        const value = checkbox.value || checkbox.closest('label').textContent.trim();
                        if (!selectedFilters[group]) {
                            selectedFilters[group] = [];
                        }
                        selectedFilters[group].push(value.toLowerCase());
                    }
                });

                cards.forEach(card => {
                    const cardTitle = (card.dataset.title || '').toLowerCase();
                    const cardFilterTags = card.dataset.tags ? card.dataset.tags.toLowerCase().split(',') : [];
                    const cardDomain = (card.dataset.domain || '').toLowerCase();
                    const cardAssessmentType = (card.dataset.assessmentType || '').toLowerCase();
                    const cardDifficulty = (card.dataset.difficulty || '').toLowerCase();
                    const cardDepthOfKnowledge = (card.dataset.depthOfKnowledge || '').toLowerCase();
                    const cardOwnedBy = (card.dataset.ownedBy || '').toLowerCase();
                    const cardHumanLanguage = (card.dataset.humanLanguage || '').toLowerCase();
                    const cardToBeUsedIn = (card.dataset.toBeUsedIn || '').toLowerCase();

                    let domainSpecificMatch = false;
                    if (searchTerm === "tech" && cardDomain === "tech") {
                        domainSpecificMatch = true;
                    } else if (searchTerm === "non-tech" && cardDomain === "non-tech") {
                        domainSpecificMatch = true;
                    } else if (searchTerm && searchTerm !== "tech" && searchTerm !== "non-tech") {
                         domainSpecificMatch = cardDomain.includes(searchTerm);
                    } else if (!searchTerm) {
                        domainSpecificMatch = true;
                    }

                    const matchesSearch = !searchTerm ||
                                          cardTitle.includes(searchTerm) ||
                                          cardFilterTags.some(tag => tag.trim().includes(searchTerm)) ||
                                          domainSpecificMatch;


                    let matchesFilters = true;
                    for (const group in selectedFilters) {
                        if (selectedFilters[group].length > 0) {
                            let groupMatch = false;
                            const cardValuesForGroup = {
                                'domain': [cardDomain],
                                'programming-language': cardFilterTags.map(t => t.trim()),
                                'assessment': [cardAssessmentType],
                                'difficulty': [cardDifficulty],
                                'depth-of-knowledge': [cardDepthOfKnowledge],
                                'owned-by': [cardOwnedBy],
                                'tags': cardFilterTags.map(t => t.trim()),
                                'human-language': [cardHumanLanguage],
                                'to-be-used-in': [cardToBeUsedIn]
                            };

                            const currentCardGroupValues = cardValuesForGroup[group] || [];
                            groupMatch = selectedFilters[group].some(filterVal => currentCardGroupValues.includes(filterVal));

                            if (!groupMatch) {
                                matchesFilters = false;
                                break;
                            }
                        }
                    }

                    if (matchesSearch && matchesFilters) {
                        card.style.display = 'flex';
                    } else {
                        card.style.display = 'none';
                    }
                });
                 updateQuestionCount();
            }

            function applySortAndFilter() {
                if (!assessmentCardsGrid) return;
                const allCards = Array.from(assessmentCardsGrid.children);
                const sortByRadio = document.querySelector('input[name="sort-by"]:checked');
                const sortBy = sortByRadio ? sortByRadio.value : 'popularity';

                allCards.sort((a, b) => {
                    const titleA = (a.dataset.title || '');
                    const titleB = (b.dataset.title || '');
                    const dateA = new Date(a.dataset.createdDate || 0);
                    const dateB = new Date(b.dataset.createdDate || 0);
                    const popA = parseInt(a.dataset.popularity) || 0;
                    const popB = parseInt(b.dataset.popularity) || 0;

                    if (sortBy === 'name') {
                        return titleA.localeCompare(titleB);
                    } else if (sortBy === 'recency') {
                        if (isNaN(dateA.getTime()) && isNaN(dateB.getTime())) return 0;
                        if (isNaN(dateA.getTime())) return 1;
                        if (isNaN(dateB.getTime())) return -1;
                        return dateB - dateA;
                    } else if (sortBy === 'popularity') {
                        return popB - popA;
                    }
                    return 0;
                });

                allCards.forEach(card => assessmentCardsGrid.appendChild(card));
                filterAssessmentCards();
            }


            // --- Event Listeners Setup ---
            if (behaviorCheckToggle && sidebarCollapsibleContent) {
                behaviorCheckToggle.addEventListener('click', () => {
                    body.classList.toggle('sidebar-collapsed');
                });
            }

            document.querySelectorAll('.filter-section').forEach(section => {
                const header = section.querySelector('h3');
                const toggleButton = section.querySelector('h3 .toggle-btn');
                const optionsList = section.querySelector('.options');
                const viewMoreBtnInSection = section.querySelector('.view-more-btn');
                const limit = parseInt(viewMoreBtnInSection?.dataset.limit || '-1', 10);


                if (header && toggleButton && optionsList) {
                    header.addEventListener('click', (event) => {
                        if (event.target.closest('input[type="checkbox"], input[type="radio"], label, .view-more-btn')) return;

                        const isActive = section.classList.toggle('active');
                        toggleButton.setAttribute('aria-expanded', isActive.toString());

                        if(isActive){
                            optionsList.style.opacity = 1;
                            optionsList.style.pointerEvents = 'auto';
                            optionsList.style.display = optionsList.classList.contains('two-column') ? 'flex' : 'block';
                            optionsList.querySelectorAll('ul').forEach(nestedUl => nestedUl.style.display = 'block');
                             setTimeout(() => {
                                const currentMaxHeight = calculateMaxHeight(optionsList);
                                optionsList.style.maxHeight = currentMaxHeight;
                             }, 0);

                            if (viewMoreBtnInSection && limit !== -1) {
                                const listItems = Array.from(optionsList.querySelectorAll('li'));
                                viewMoreBtnInSection.style.display = listItems.length > limit ? 'block' : 'none';
                                if (viewMoreBtnInSection.textContent.trim().toLowerCase() === 'view less') {
                                     viewMoreBtnInSection.textContent = 'View More';
                                     listItems.forEach((item, index) => {
                                         if (index >= limit) item.classList.add('hidden-item');
                                     });
                                }
                            }
                        } else {
                            optionsList.style.maxHeight = 0;
                            optionsList.style.opacity = 0;
                            optionsList.style.pointerEvents = 'none';
                            optionsList.querySelectorAll('ul').forEach(nestedUl => nestedUl.style.display = 'none');
                            if (viewMoreBtnInSection) viewMoreBtnInSection.style.display = 'none';
                        }
                    });
                    const isActiveInitial = section.classList.contains('active');
                    toggleButton.setAttribute('aria-expanded', isActiveInitial.toString());
                    if(isActiveInitial){
                        optionsList.style.opacity = 1; optionsList.style.pointerEvents = 'auto';
                        optionsList.style.display = optionsList.classList.contains('two-column') ? 'flex' : 'block';
                        optionsList.querySelectorAll('ul').forEach(nestedUl => nestedUl.style.display = 'block');
                        setTimeout(() => {
                            const currentMaxHeight = calculateMaxHeight(optionsList);
                            optionsList.style.maxHeight = currentMaxHeight;
                        }, 0);
                        if (viewMoreBtnInSection && limit !== -1) {
                           const listItems = Array.from(optionsList.querySelectorAll('li'));
                           viewMoreBtnInSection.style.display = listItems.length > limit ? 'block' : 'none';
                           const isShowingLess = viewMoreBtnInSection.textContent.trim().toLowerCase() === 'view more';
                           listItems.forEach((item, index) => {
                               if (isShowingLess && index >= limit) item.classList.add('hidden-item');
                               else item.classList.remove('hidden-item');
                           });
                       }
                    } else {
                       optionsList.style.maxHeight = 0; optionsList.style.opacity = 0; optionsList.style.pointerEvents = 'none';
                       optionsList.querySelectorAll('ul').forEach(nestedUl => nestedUl.style.display = 'none');
                       if (viewMoreBtnInSection) viewMoreBtnInSection.style.display = 'none';
                    }
                }
            });


            if (searchInput) searchInput.addEventListener('input', applySortAndFilter);

            if (clearAllButton) {
                clearAllButton.addEventListener('click', () => {
                    document.querySelectorAll('.filter-checkbox').forEach(input => input.checked = false);
                    if (searchInput) searchInput.value = '';
                    document.querySelectorAll('.filter-section.active').forEach(section => {
                        section.classList.remove('active');
                        const toggleBtn = section.querySelector('h3 .toggle-btn');
                        const optionsList = section.querySelector('.options');
                        const viewMoreBtnInSection = section.querySelector('.view-more-btn');
                        const limit = parseInt(viewMoreBtnInSection?.dataset.limit || '-1', 10);

                        if(toggleBtn) { toggleBtn.setAttribute('aria-expanded', 'false'); }
                        if(optionsList) { optionsList.style.maxHeight = 0; optionsList.style.opacity = 0; optionsList.style.pointerEvents = 'none'; }

                        if (viewMoreBtnInSection) {
                            viewMoreBtnInSection.style.display = 'none';
                            viewMoreBtnInSection.textContent = 'View More';
                            if (limit !== -1) {
                                const listItems = Array.from(optionsList.querySelectorAll('li'));
                                listItems.forEach((item, index) => {
                                    if (index >= limit) item.classList.add('hidden-item');
                                });
                            }
                        }
                    });
                    const popularityRadio = document.querySelector('#sort-by-options input[name="sort-by"][value="popularity"]');
                    if (popularityRadio) popularityRadio.checked = true;
                    if(sortByDisplayValue) sortByDisplayValue.textContent = 'Popularity';
                    if(selectedFiltersContainer) selectedFiltersContainer.innerHTML = '';
                    selectedFilterMap.clear();
                    applySortAndFilter();
                });
            }

            document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const label = this.closest('label');
                    if (!label) return;
                    const filterText = label.textContent.trim();

                    if (this.type === 'radio' && this.name === 'sort-by') {
                         if(sortByDisplayValue) sortByDisplayValue.textContent = filterText;
                    } else {
                        if (this.checked) {
                            if (!selectedFilterMap.has(this)) {
                                const filterTag = document.createElement('div');
                                filterTag.classList.add('selected-filter-tag');
                                filterTag.textContent = filterText;
                                const removeIcon = document.createElement('i');
                                removeIcon.classList.add('fas', 'fa-times', 'remove-tag');
                                removeIcon.onclick = () => {
                                    if(selectedFiltersContainer) selectedFiltersContainer.removeChild(filterTag);
                                    this.checked = false; selectedFilterMap.delete(this); applySortAndFilter();
                                };
                                filterTag.appendChild(removeIcon);
                                if(selectedFiltersContainer) selectedFiltersContainer.appendChild(filterTag);
                                selectedFilterMap.set(this, filterTag);
                            }
                        } else {
                            if (selectedFilterMap.has(this)) {
                                if(selectedFiltersContainer) selectedFiltersContainer.removeChild(selectedFilterMap.get(this));
                                selectedFilterMap.delete(this);
                            }
                        }
                    }
                    applySortAndFilter();
                });
            });

            const checkedSortBy = document.querySelector('#sort-by-options input[name="sort-by"]:checked');
            if (checkedSortBy && sortByDisplayValue) {
                const label = checkedSortBy.closest('label');
                if (label) sortByDisplayValue.textContent = label.textContent.trim();
            } else if (sortByDisplayValue) {
                sortByDisplayValue.textContent = 'Popularity';
            }

             document.querySelectorAll('.filter-checkbox:checked').forEach(checkbox => {
                if (checkbox.type === 'checkbox') {
                    const label = checkbox.closest('label');
                    if (!label) return;
                    const filterText = label.textContent.trim();
                    if (!selectedFilterMap.has(checkbox)) {
                        const filterTag = document.createElement('div');
                        filterTag.classList.add('selected-filter-tag');
                        filterTag.textContent = filterText;
                        const removeIcon = document.createElement('i');
                        removeIcon.classList.add('fas', 'fa-times', 'remove-tag');
                        removeIcon.onclick = () => {
                            if(selectedFiltersContainer) selectedFiltersContainer.removeChild(filterTag);
                            checkbox.checked = false; selectedFilterMap.delete(checkbox); applySortAndFilter();
                        };
                        filterTag.appendChild(removeIcon);
                        if(selectedFiltersContainer) selectedFiltersContainer.appendChild(filterTag);
                        selectedFilterMap.set(checkbox, filterTag);
                    }
                }
            });

            // UPDATED: Set Assessment Name from Session Storage
            const savedAssessmentName = sessionStorage.getItem('assessmentName') || 'Default Assessment Name';
            if (assessmentNameDisplay) {
                assessmentNameDisplay.textContent = savedAssessmentName;
            }
            // IMPORTANT: Save this name to a consistent key for all pages to use
            sessionStorage.setItem('currentAssessmentNameForLibrary', savedAssessmentName);


             window.addEventListener('resize', () => {
                 filterSections.forEach(section => {
                    const optionsList = section.querySelector('.options');
                     if (section.classList.contains('active') && optionsList) {
                         setTimeout(() => {
                            const currentMaxHeight = calculateMaxHeight(optionsList);
                            optionsList.style.maxHeight = currentMaxHeight;
                         }, 0);
                     }
                 });
                if (window.innerWidth <= 768) {
                    if(body.classList.contains('sidebar-collapsed')) body.classList.remove('sidebar-collapsed');
                }
             });
            if (window.innerWidth <= 768) {
                if(body.classList.contains('sidebar-collapsed')) body.classList.remove('sidebar-collapsed');
            }


            // --- Skip Button Functionality ---
            if (skipButton) {
                skipButton.addEventListener('click', () => body.classList.add('skip-active'));
            }
            if (questionLibraryOption) {
                questionLibraryOption.addEventListener('click', () => body.classList.remove('skip-active'));
            }
            if (createAssessmentOption) {
                createAssessmentOption.addEventListener('click', () => {
                    window.location.href = 'classic_question_type.html';
                });
            }

            // --- *** NEW/FIXED SCRIPT FOR MODAL FUNCTIONALITY *** ---
            // This section connects the UI to the cart logic functions

            // Open Modal
            if (cartIconContainer) {
                cartIconContainer.addEventListener('click', () => {
                    // Populate with current assessment name from session storage
                    const currentName = sessionStorage.getItem('currentAssessmentNameForLibrary') || 'My New Assessment';
                    if(assessmentNameInput) assessmentNameInput.value = currentName;

                    renderSelectedQuestionsList(); // Populate the list
                    if (cartModalOverlay) cartModalOverlay.style.display = 'flex';
                });
            }

            // Close Modal
            if (cartModalCloseBtn) {
                cartModalCloseBtn.addEventListener('click', () => {
                    if (cartModalOverlay) cartModalOverlay.style.display = 'none';
                });
            }

            // Close modal by clicking background
            if (cartModalOverlay) {
                cartModalOverlay.addEventListener('click', (e) => {
                    if (e.target === cartModalOverlay) {
                        cartModalOverlay.style.display = 'none';
                    }
                });
            }

            // Clear List button inside modal
            if (clearItemListBtn) {
                clearItemListBtn.addEventListener('click', () => {
                    if (selectedAssessmentsInCart.length > 0) {
                        showClearListConfirmation();
                    } else {
                        showCustomAlert("The list is already empty.", "info");
                    }
                });
            }

            // Create Assessment button inside modal
            if (createAssessmentBtnModal) {
                createAssessmentBtnModal.addEventListener('click', () => {
                    if (selectedAssessmentsInCart.length === 0) {
                        return showCustomAlert("Please add questions to the list first.", "error");
                    }
                    
                    const assessmentName = assessmentNameInput.value.trim();
                    if (!assessmentName) {
                        return showCustomAlert("Please enter an assessment name.", "error");
                    }

                    // Calculate totals
                    let totalQuestions = selectedAssessmentsInCart.length;
                    let totalPoints = 0;
                    let totalMinutes = 0;
                    selectedAssessmentsInCart.forEach(item => {
                        totalPoints += parseInt(item.points) || 0;
                        const timeParts = (item.time || "0-00").split('-');
                        totalMinutes += parseInt(timeParts[0], 10) || 0;
                    });

                    // Create the new assessment object
                    const newAssessment = {
                        assessmentId: 'asmt_' + Date.now(),
                        assessmentName: assessmentName,
                        createdAt: new Date().toISOString(),
                        questions: selectedAssessmentsInCart,
                        totalQuestions: totalQuestions,
                        totalTime: totalMinutes,
                        totalPoints: totalPoints
                    };

                    // Get existing library and add the new one
                    let library = [];
                    const storedLibrary = localStorage.getItem(LIBRARY_STORAGE_KEY);
                    if (storedLibrary) {
                        try {
                            library = JSON.parse(storedLibrary);
                            if(!Array.isArray(library)) library = [];
                        } catch(e) {
                            console.error("Error parsing library from storage", e);
                            library = [];
                        }
                    }
                    library.unshift(newAssessment);
                    localStorage.setItem(LIBRARY_STORAGE_KEY, JSON.stringify(library));

                    // Clear the current cart and related UI
                   // selectedAssessmentsInCart = [];
                   // saveAddedItemsToLocalStorage([]);
                    updateCartCountHeader();
                    
                    showCustomAlert(`Assessment "${assessmentName}" created and saved to library.`, "success");
                    if (cartModalOverlay) cartModalOverlay.style.display = 'none';

                    // Redirect to the assessment library
                    setTimeout(() => {
                        window.location.href = "/configuration/";
                    }, 1500);
                });
            }

            // --- END OF NEW/FIXED SCRIPT ---

            // --- Initial Population and Final Call ---
            populateAssessmentCards();

            // --- Event listener for Customize buttons on cards ---
            assessmentCardsGrid.addEventListener('click', function(event) {
                const customizeBtn = event.target.closest('.customize-card-btn');
                if (customizeBtn) {
                    const assessmentId = customizeBtn.dataset.assessmentId;
                    const selectedAssessment = assessmentData.find(a => a.id === assessmentId);

                    if (!selectedAssessment.isPremium) {
                        if (selectedAssessment && selectedAssessment.customizeLink) {
                            sessionStorage.setItem('selectedAssessmentDetails', JSON.stringify(selectedAssessment));
                            window.location.href = selectedAssessment.customizeLink;
                        } else {
                            console.error('Assessment or customize link not found for ID:', assessmentId);
                            showCustomAlert('Customize link not available for this assessment.', 'error');
                        }
                    } else {
                        showCustomAlert("This is a premium assessment. Please upgrade your plan to customize.", "info");
                    }
                }
            });
        });
    </script>
</body>
</html>
